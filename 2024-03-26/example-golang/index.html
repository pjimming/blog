<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>『实战』使用Golang实现Redis经典应用案例 - 江明说|Jimmy Talk</title><meta http-equiv=x-dns-prefetch-control content="on">
<link rel=dns-prefetch href=//cdn.jsdelivr.net><link rel=dns-prefetch href=//pjimming.github.io><meta name=Description content="江明说"><meta property="og:url" content="https://blog.pjmcode.top/2024-03-26/example-golang/"><meta property="og:site_name" content="江明说|Jimmy Talk"><meta property="og:title" content="『实战』使用Golang实现Redis经典应用案例"><meta property="og:description" content="使用 Golang+Redis 实现一些经典业务案例，如签到功能、分布式锁、限流器、消息队列、计数器、排行榜、订阅发布等"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-26T14:18:00+08:00"><meta property="article:modified_time" content="2025-01-26T20:30:29+08:00"><meta property="article:tag" content="Redis"><meta property="article:tag" content="Golang"><meta property="article:tag" content="实战"><meta property="og:image" content="https://blog.pjmcode.top/logo.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.pjmcode.top/logo.png"><meta name=twitter:title content="『实战』使用Golang实现Redis经典应用案例"><meta name=twitter:description content="使用 Golang+Redis 实现一些经典业务案例，如签到功能、分布式锁、限流器、消息队列、计数器、排行榜、订阅发布等"><meta name=application-name content="江明说"><meta name=apple-mobile-web-app-title content="江明说"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=/images/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.pjmcode.top/2024-03-26/example-golang/><link rel=prev href=https://blog.pjmcode.top/2024-03-24/pprof-theory/><link rel=next href=https://blog.pjmcode.top/2024-04-01/qiniu/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"『实战』使用Golang实现Redis经典应用案例","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.pjmcode.top\/2024-03-26\/example-golang\/"},"genre":"posts","keywords":"redis, golang, 实战","wordcount":8734,"url":"https:\/\/blog.pjmcode.top\/2024-03-26\/example-golang\/","datePublished":"2024-03-26T14:18:00+08:00","dateModified":"2025-01-26T20:30:29+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"PanJM"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="江明说|Jimmy Talk"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/favicon.ico data-srcset="/images/favicon.ico, /images/favicon.ico 1.5x, /images/favicon.ico 2x" data-sizes=auto alt=/images/favicon.ico title=/images/favicon.ico>Jimmy Talk</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class='fa-solid fa-box-archive'></i> 所有文章 </a><a class=menu-item href=/tags/><i class='fa-solid fa-tag'></i> 标签 </a><a class=menu-item href=/categories/><i class='fa-solid fa-table-list'></i> 分类 </a><a class=menu-item href=/friend/><i class='fa-solid fa-user-group'></i> 友链 </a><a class=menu-item href=/book-list/><i class='fa-solid fa-book'></i> 书单 </a><a class=menu-item href=/about/><i class='fa-regular fa-address-card'></i> 关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="江明说|Jimmy Talk"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/favicon.ico data-srcset="/images/favicon.ico, /images/favicon.ico 1.5x, /images/favicon.ico 2x" data-sizes=auto alt=/images/favicon.ico title=/images/favicon.ico>Jimmy Talk</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title><i class='fa-solid fa-box-archive'></i>所有文章</a><a class=menu-item href=/tags/ title><i class='fa-solid fa-tag'></i>标签</a><a class=menu-item href=/categories/ title><i class='fa-solid fa-table-list'></i>分类</a><a class=menu-item href=/friend/ title><i class='fa-solid fa-user-group'></i>友链</a><a class=menu-item href=/book-list/ title><i class='fa-solid fa-book'></i>书单</a><a class=menu-item href=/about/ title><i class='fa-regular fa-address-card'></i>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">『实战』使用Golang实现Redis经典应用案例</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/pjimming/ title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>PanJM</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/redis/><i class="far fa-folder fa-fw" aria-hidden=true></i>Redis</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2024-03-26>2024-03-26</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 8734 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 18 分钟&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=https://picx-img.pjmcode.top/20240326/image-image.969ibnzd46.webp data-srcset="https://picx-img.pjmcode.top/20240326/image-image.969ibnzd46.webp, https://picx-img.pjmcode.top/20240326/image-image.969ibnzd46.webp 1.5x, https://picx-img.pjmcode.top/20240326/image-image.969ibnzd46.webp 2x" data-sizes=auto alt=https://picx-img.pjmcode.top/20240326/image-image.969ibnzd46.webp title=https://picx-img.pjmcode.top/20240326/image-image.969ibnzd46.webp></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#00-预先准备>00-预先准备</a><ul><li><a href=#下载-go-第三方包依赖>下载 Go 第三方包依赖</a></li><li><a href=#初始化-redis-连接>初始化 Redis 连接</a></li><li><a href=#通用方法>通用方法</a><ul><li><a href=#commonconcurrent_event_loggo-日志收集及打印工具><code>common/concurrent_event_log.go</code>: 日志收集及打印工具</a></li><li><a href=#commonconcurrent_routinego-并发执行器><code>common/concurrent_routine.go</code>: 并发执行器</a></li></ul></li><li><a href=#main-方法>main 方法</a></li></ul></li><li><a href=#01-基于incr的签到功能>01-基于<code>Incr</code>的签到功能</a><ul><li><a href=#业务分析>业务分析</a></li><li><a href=#代码实现>代码实现</a></li><li><a href=#测试功能go-run-maingo-ex01-1165894833417101>测试功能：<code>go run main.go Ex01 1165894833417101</code></a></li></ul></li><li><a href=#02-基于setnx的分布式锁>02-基于<code>SETNX</code>的分布式锁</a><ul><li><a href=#代码实现-1>代码实现</a></li><li><a href=#测试功能go-run-maingo-ex02>测试功能：<code>go run main.go Ex02</code></a></li></ul></li><li><a href=#03-基于incr和decr的简单限流器>03-基于<code>Incr</code>和<code>Decr</code>的简单限流器</a><ul><li><a href=#代码实现-2>代码实现</a></li><li><a href=#测试功能go-run-maingo-ex03>测试功能：<code>go run main.go Ex03</code></a></li></ul></li><li><a href=#04-基于list的消息队列>04-基于<code>List</code>的消息队列</a><ul><li><a href=#代码实现-3>代码实现</a></li><li><a href=#测试功能go-run-maingo-ex04>测试功能：<code>go run main.go Ex04</code></a></li></ul></li><li><a href=#05-基于hash的计数器>05-基于<code>Hash</code>的计数器</a><ul><li><a href=#代码实现-4>代码实现</a></li><li><a href=#测试功能>测试功能</a></li></ul></li><li><a href=#06-基于zset的排行榜>06-基于<code>Zset</code>的排行榜</a><ul><li><a href=#代码实现-5>代码实现</a></li><li><a href=#测试功能-1>测试功能</a></li></ul></li><li><a href=#07-基于pubsub的消息订阅>07-基于<code>PubSub</code>的消息订阅</a><ul><li><a href=#代码实现-6>代码实现</a></li><li><a href=#测试结果go-run-maingo-ex07>测试结果：<code>go run main.go Ex07</code></a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div></div><div class=content id=content><p>使用 Golang+Redis 实现一些经典业务案例，如签到功能、分布式锁、限流器、消息队列、计数器、排行榜、订阅发布等</p><hr><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>前言<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>该文章中涉及到的代码：<a href=https://github.com/pjimming/blog-code/tree/main/go-redis-example target=_blank rel="noopener noreffer">https://github.com/pjimming/blog-code/tree/main/go-redis-example</a></div></div></div><h2 id=00-预先准备>00-预先准备</h2><p>项目文件架构：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>base<span class=o>)</span> ➜  go-redis-example git:<span class=o>(</span>main<span class=o>)</span> tree .
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── Makefile
</span></span><span class=line><span class=cl>├── README.md
</span></span><span class=line><span class=cl>├── common
</span></span><span class=line><span class=cl>│   ├── concurrent_event_log.go
</span></span><span class=line><span class=cl>│   └── coucurrent_routine.go
</span></span><span class=line><span class=cl>├── example
</span></span><span class=line><span class=cl>│   ├── ex01_checkin.go
</span></span><span class=line><span class=cl>│   ├── ex02_setnx.go
</span></span><span class=line><span class=cl>│   ├── ex03_limiter.go
</span></span><span class=line><span class=cl>│   ├── ex04_message.go
</span></span><span class=line><span class=cl>│   ├── ex05_hash_count.go
</span></span><span class=line><span class=cl>│   ├── ex06_ranking.go
</span></span><span class=line><span class=cl>│   ├── ex07_pubsub.go
</span></span><span class=line><span class=cl>│   ├── redis_client.go
</span></span><span class=line><span class=cl>│   └── redis_client_test.go
</span></span><span class=line><span class=cl>├── go.mod
</span></span><span class=line><span class=cl>├── go.sum
</span></span><span class=line><span class=cl>└── main.go
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>3</span> directories, <span class=m>16</span> files
</span></span></code></pre></td></tr></table></div></div><h3 id=下载-go-第三方包依赖>下载 Go 第三方包依赖</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go get github.com/redis/go-redis/v9
</span></span><span class=line><span class=cl>go get github.com/stretchr/testify
</span></span></code></pre></td></tr></table></div></div><h3 id=初始化-redis-连接>初始化 Redis 连接</h3><ol><li><p>确保有一个 Redis 环境，若本地没有，请自行使用搜索引擎进行安装</p></li><li><p>编写以下代码，初始化 Redis 连接</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// example/redis_client.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nx>example</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/redis/go-redis/v9&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>RedisCli</span> <span class=o>*</span><span class=nx>redis</span><span class=p>.</span><span class=nx>Client</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>RedisCli</span> <span class=p>=</span> <span class=nx>redis</span><span class=p>.</span><span class=nf>NewClient</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>redis</span><span class=p>.</span><span class=nx>Options</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Addr</span><span class=p>:</span>     <span class=s>&#34;127.0.0.1:6379&#34;</span><span class=p>,</span> <span class=c1>// Your Redis Address
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>Password</span><span class=p>:</span> <span class=s>&#34;123456&#34;</span><span class=p>,</span>         <span class=c1>// Your Redis Password
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>Ping</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>()).</span><span class=nf>Err</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>编写测试代码，测试连接是否成功</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// example/redis_client_test.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nx>example</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;testing&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>TestNewRedis</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ast</span> <span class=o>:=</span> <span class=nx>assert</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ast</span><span class=p>.</span><span class=nf>NotNil</span><span class=p>(</span><span class=nx>RedisCli</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>ast</span><span class=p>.</span><span class=nf>Nil</span><span class=p>(</span><span class=nx>RedisCli</span><span class=p>.</span><span class=nf>Ping</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>()).</span><span class=nf>Err</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>执行命令：<code>go test ./example -run="^TestNewRedis"</code></p><p>得到如下结果表示测试通过，Redis 连接初始化成功：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>base<span class=o>)</span> ➜  go-redis-example git:<span class=o>(</span>main<span class=o>)</span> ✗ go <span class=nb>test</span> ./example -run<span class=o>=</span><span class=s2>&#34;^TestNewRedis&#34;</span>
</span></span><span class=line><span class=cl>ok      go-redis-example/example        0.287s
</span></span></code></pre></td></tr></table></div></div></li></ol><h3 id=通用方法>通用方法</h3><p>在 <code>common</code> 文件夹下新建两个文件，分别是 <code>concurrent_event_log.go</code> 和 <code>concurrent_routine.go</code></p><h4 id=commonconcurrent_event_loggo-日志收集及打印工具><code>common/concurrent_event_log.go</code>: 日志收集及打印工具</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>common</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;sort&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ConcurrentEventLogger</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>eventLogs</span> <span class=p>[]</span><span class=nx>EventLog</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// EventLog 搜集日志的结构
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>EventLog</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>EventTime</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>	<span class=nx>Log</span>       <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewConcurrentEventLog</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>logsLength</span> <span class=kt>int</span><span class=p>)</span> <span class=o>*</span><span class=nx>ConcurrentEventLogger</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>logsLength</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>logsLength</span> <span class=p>=</span> <span class=mi>32</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>logContainer</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>EventLog</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>logsLength</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>ConcurrentEventLogger</span><span class=p>{</span><span class=nx>eventLogs</span><span class=p>:</span> <span class=nx>logContainer</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Append 追加日志
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>ceLog</span> <span class=o>*</span><span class=nx>ConcurrentEventLogger</span><span class=p>)</span> <span class=nf>Append</span><span class=p>(</span><span class=nx>mLog</span> <span class=nx>EventLog</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>ceLog</span><span class=p>.</span><span class=nx>eventLogs</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>ceLog</span><span class=p>.</span><span class=nx>eventLogs</span><span class=p>,</span> <span class=nx>mLog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// PrintLogs  日志按时间正序输出
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>ceLog</span> <span class=o>*</span><span class=nx>ConcurrentEventLogger</span><span class=p>)</span> <span class=nf>PrintLogs</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>sort</span><span class=p>.</span><span class=nf>Slice</span><span class=p>(</span><span class=nx>ceLog</span><span class=p>.</span><span class=nx>eventLogs</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>i</span><span class=p>,</span> <span class=nx>j</span> <span class=kt>int</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>ceLog</span><span class=p>.</span><span class=nx>eventLogs</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>EventTime</span><span class=p>.</span><span class=nf>Before</span><span class=p>(</span><span class=nx>ceLog</span><span class=p>.</span><span class=nx>eventLogs</span><span class=p>[</span><span class=nx>j</span><span class=p>].</span><span class=nx>EventTime</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>ceLog</span><span class=p>.</span><span class=nx>eventLogs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>ceLog</span><span class=p>.</span><span class=nx>eventLogs</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Log</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// LogFormat 包含通用日志前缀 [2022-11-27T12:36:00.213454+08:00] routine[5]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>LogFormat</span><span class=p>(</span><span class=nx>routine</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>format</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>a</span> <span class=o>...</span><span class=nx>any</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>tpl</span> <span class=o>:=</span> <span class=s>&#34;[%s] routine[%d] &#34;</span> <span class=o>+</span> <span class=nx>format</span>
</span></span><span class=line><span class=cl>	<span class=nx>sr</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>any</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Format</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>RFC3339Nano</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>routine</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>sr</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>sr</span><span class=p>,</span> <span class=nx>a</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=nx>tpl</span><span class=p>,</span> <span class=nx>sr</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=commonconcurrent_routinego-并发执行器><code>common/concurrent_routine.go</code>: 并发执行器</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>common</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;sync&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ConcurrentRoutine 并发执行器对象定义
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>ConcurrentRoutine</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>routineNums</span>           <span class=kt>int</span>                    <span class=c1>// 定义并发协程的数量
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>concurrentEventLogger</span> <span class=o>*</span><span class=nx>ConcurrentEventLogger</span> <span class=c1>// 并发日志搜集器
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// CInstParams 定义传入callBack的参数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>CInstParams</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Routine</span>               <span class=kt>int</span> <span class=c1>// 协程编号
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ConcurrentEventLogger</span> <span class=o>*</span><span class=nx>ConcurrentEventLogger</span>
</span></span><span class=line><span class=cl>	<span class=nx>CustomParams</span>          <span class=kd>interface</span><span class=p>{}</span> <span class=c1>// 用户自定义参数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>callBack</span> <span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>params</span> <span class=nx>CInstParams</span><span class=p>)</span> <span class=c1>// 定义一个用户自定义执行函数
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// NewConcurrentRoutine 初始化一个并发执行器
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewConcurrentRoutine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>routineNums</span> <span class=kt>int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>concurrentEventLog</span> <span class=o>*</span><span class=nx>ConcurrentEventLogger</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>*</span><span class=nx>ConcurrentRoutine</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>ConcurrentRoutine</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>routineNums</span><span class=p>:</span>           <span class=nx>routineNums</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>concurrentEventLogger</span><span class=p>:</span> <span class=nx>concurrentEventLog</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Run 并发执行用户自定义函数 workFun
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>cInst</span> <span class=o>*</span><span class=nx>ConcurrentRoutine</span><span class=p>)</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>customParams</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>workFun</span> <span class=nx>callBack</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>wg</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>cInst</span><span class=p>.</span><span class=nx>routineNums</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>mRoutine</span> <span class=o>:=</span> <span class=nx>i</span>
</span></span><span class=line><span class=cl>		<span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 启动协程模拟并发逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=nx>mCtx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>mRoutine</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>mParams</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>defer</span> <span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=nf>workFun</span><span class=p>(</span>
</span></span><span class=line><span class=cl>				<span class=nx>mCtx</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>CInstParams</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>Routine</span><span class=p>:</span>               <span class=nx>mRoutine</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>ConcurrentEventLogger</span><span class=p>:</span> <span class=nx>cInst</span><span class=p>.</span><span class=nx>concurrentEventLogger</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>CustomParams</span><span class=p>:</span>          <span class=nx>mParams</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>mRoutine</span><span class=p>,</span> <span class=nx>customParams</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=main-方法>main 方法</h3><p>作为程序的入口，我们为了更好的运行实现好的案例，需要对输入的参数进行解析。例如要运行的 Example，运行需要的参数信息等。</p><p><code>main.go</code>代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;strings&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;go-redis-example/example&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>_</span> <span class=p>=</span> <span class=nx>example</span><span class=p>.</span><span class=nx>RedisCli</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>argsProg</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Args</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>argsWithoutProg</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>argsProg</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>argsWithoutProg</span> <span class=p>=</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;输入参数:\n%s\n----------\n&#34;</span><span class=p>,</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>argsWithoutProg</span><span class=p>,</span> <span class=s>&#34;\n&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>runExample</span> <span class=o>:=</span> <span class=nx>argsWithoutProg</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=nx>exampleParams</span> <span class=o>:=</span> <span class=nx>argsWithoutProg</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=nx>runExample</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;Ex01&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>example</span><span class=p>.</span><span class=nf>Ex01</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>exampleParams</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;Ex02&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>example</span><span class=p>.</span><span class=nf>Ex02</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;Ex03&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>example</span><span class=p>.</span><span class=nf>Ex03</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;Ex04&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>example</span><span class=p>.</span><span class=nf>Ex04</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;Ex05&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>example</span><span class=p>.</span><span class=nf>Ex05</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>exampleParams</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;Ex06&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>example</span><span class=p>.</span><span class=nf>Ex06</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>exampleParams</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;Ex07&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>example</span><span class=p>.</span><span class=nf>Ex07</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;not support type: %s&#34;</span><span class=p>,</span> <span class=nx>runExample</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>暂未实现的 example 注释即可，等实现完成之后，记得取消注释，否则无法运行。</p><p>到此为止，我们预先的准备工作都已经就绪，现在开始实战案例。</p><h2 id=01-基于incr的签到功能>01-基于<code>Incr</code>的签到功能</h2><h3 id=业务分析>业务分析</h3><p>对于每日签到功能，我们需要记录连续签到天数，并且如果用户在当天没有签到的话，清空计数。</p><p>可以发现使用 Redis 的 String 类型搭配设置过期时间就可以很好的解决这个问题。</p><p>对于过期时间的设置，如果我们在当天签到成功，则第二天不签到就会清空计数。所以把过期时间设置在第三天的凌晨 0 点即可。</p><h3 id=代码实现>代码实现</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>example</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;strconv&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=nx>continueCheckKey</span> <span class=p>=</span> <span class=s>&#34;cc_uid_%d&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Ex01</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>params</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>userID</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseInt</span><span class=p>(</span><span class=nx>params</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;参数错误：params = %+v, error = %v&#34;</span><span class=p>,</span> <span class=nx>params</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nf>ex01AddContinueDays</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>userID</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 用户签到
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>ex01AddContinueDays</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>userID</span> <span class=kt>int64</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>key</span> <span class=o>:=</span> <span class=nf>ex01GetContinueCheckKey</span><span class=p>(</span><span class=nx>userID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 1. 签到天数+1
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>Incr</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>key</span><span class=p>).</span><span class=nf>Err</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;user[%d]签到失败, %v&#34;</span><span class=p>,</span> <span class=nx>userID</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 2. 设置签到时间为后天0点过期
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>expAt</span> <span class=o>:=</span> <span class=nf>ex01BeginningOfDay</span><span class=p>().</span><span class=nf>Add</span><span class=p>(</span><span class=mi>48</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Hour</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>ExpireAt</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>expAt</span><span class=p>).</span><span class=nf>Err</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 3. 打印用户签到天数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>day</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>ex01GetUserCheckInDays</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>userID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;User[%d]连续签到：%d天，过期时间：%s&#34;</span><span class=p>,</span> <span class=nx>userID</span><span class=p>,</span> <span class=nx>day</span><span class=p>,</span> <span class=nx>expAt</span><span class=p>.</span><span class=nf>Format</span><span class=p>(</span><span class=s>&#34;2006-01-02 15:04:05&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 获取用户签到天数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>ex01GetUserCheckInDays</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>userID</span> <span class=kt>int64</span><span class=p>)</span> <span class=p>(</span><span class=kt>int64</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>key</span> <span class=o>:=</span> <span class=nf>ex01GetContinueCheckKey</span><span class=p>(</span><span class=nx>userID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>days</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>key</span><span class=p>).</span><span class=nf>Result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>daysInt</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseInt</span><span class=p>(</span><span class=nx>days</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>daysInt</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 获取今天0点时间
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>ex01BeginningOfDay</span><span class=p>()</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>now</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>y</span><span class=p>,</span> <span class=nx>m</span><span class=p>,</span> <span class=nx>d</span> <span class=o>:=</span> <span class=nx>now</span><span class=p>.</span><span class=nf>Date</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Date</span><span class=p>(</span><span class=nx>y</span><span class=p>,</span> <span class=nx>m</span><span class=p>,</span> <span class=nx>d</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Local</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 获取记录签到天数的key
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>ex01GetContinueCheckKey</span><span class=p>(</span><span class=nx>userID</span> <span class=kt>int64</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=nx>continueCheckKey</span><span class=p>,</span> <span class=nx>userID</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=测试功能go-run-maingo-ex01-1165894833417101>测试功能：<code>go run main.go Ex01 1165894833417101</code></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>base<span class=o>)</span> ➜  go-redis-example git:<span class=o>(</span>main<span class=o>)</span> ✗ go run main.go Ex01 <span class=m>1165894833417101</span>
</span></span><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex01
</span></span><span class=line><span class=cl><span class=m>1165894833417101</span>
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl>2024/03/26 15:25:05 User<span class=o>[</span>1165894833417101<span class=o>]</span>连续签到：1天，过期时间：2024-03-28 00:00:00
</span></span><span class=line><span class=cl><span class=o>(</span>base<span class=o>)</span> ➜  go-redis-example git:<span class=o>(</span>main<span class=o>)</span> ✗ go run main.go Ex01 <span class=m>1165894833417101</span>
</span></span><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex01
</span></span><span class=line><span class=cl><span class=m>1165894833417101</span>
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl>2024/03/26 15:25:09 User<span class=o>[</span>1165894833417101<span class=o>]</span>连续签到：2天，过期时间：2024-03-28 00:00:00
</span></span></code></pre></td></tr></table></div></div><h2 id=02-基于setnx的分布式锁>02-基于<code>SETNX</code>的分布式锁</h2><p>并发场景下，要求同时只有一个进程执行。即分布式情况下的逻辑、资源保护。</p><p>使用 redis 的 <code>setnx</code> 实现：</p><ul><li>单线程，且可以保证原子性</li><li>只有不存在 key 时才可以执行成功</li></ul><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden=true></i>警告<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><p>只是体验 SetNX 的特性，不是高可用的分布式锁实现</p><p>该实现存在的问题:</p><ol><li>业务超时解锁，导致并发问题。业务执行时间超过锁超时时间</li><li>redis 主备切换临界点问题。主备切换后，A 持有的锁还未同步到新的主节点时，B 可在新主节点获取锁，导致并发问题。</li><li>redis 集群脑裂，导致出现多个主节点</li></ol></div></div></div><h3 id=代码实现-1>代码实现</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>example</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;strconv&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;go-redis-example/common&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>resourceKey</span> <span class=p>=</span> <span class=s>&#34;syncKey&#34;</span>              <span class=c1>// 分布式锁的key
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>expTime</span>     <span class=p>=</span> <span class=mi>800</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span> <span class=c1>// 锁的过期时间，避免死锁
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Ex02Params</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Ex02 只是体验SetNX的特性，不是高可用的分布式锁实现
</span></span></span><span class=line><span class=cl><span class=c1>// 该实现存在的问题:
</span></span></span><span class=line><span class=cl><span class=c1>// (1) 业务超时解锁，导致并发问题。业务执行时间超过锁超时时间
</span></span></span><span class=line><span class=cl><span class=c1>// (2) redis主备切换临界点问题。主备切换后，A持有的锁还未同步到新的主节点时，B可在新主节点获取锁，导致并发问题。
</span></span></span><span class=line><span class=cl><span class=c1>// (3) redis集群脑裂，导致出现多个主节点
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>Ex02</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>eventLogger</span> <span class=o>:=</span> <span class=nx>common</span><span class=p>.</span><span class=nf>NewConcurrentEventLog</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=mi>32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// new一个并发执行器
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cInst</span> <span class=o>:=</span> <span class=nx>common</span><span class=p>.</span><span class=nf>NewConcurrentRoutine</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=nx>eventLogger</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 并发执行自定义work
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cInst</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>Ex02Params</span><span class=p>{},</span> <span class=nx>ex02Work</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 按时间顺序输出日志
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>eventLogger</span><span class=p>.</span><span class=nf>PrintLogs</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>ex02Work</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>cInstParams</span> <span class=nx>common</span><span class=p>.</span><span class=nx>CInstParams</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>routine</span> <span class=o>:=</span> <span class=nx>cInstParams</span><span class=p>.</span><span class=nx>Routine</span>
</span></span><span class=line><span class=cl>	<span class=nx>eventLogger</span> <span class=o>:=</span> <span class=nx>cInstParams</span><span class=p>.</span><span class=nx>ConcurrentEventLogger</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nf>ex02ReleaseLock</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>routine</span><span class=p>,</span> <span class=nx>eventLogger</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 1. 尝试获取锁
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>acquired</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>SetNX</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>resourceKey</span><span class=p>,</span> <span class=nx>routine</span><span class=p>,</span> <span class=nx>expTime</span><span class=p>).</span><span class=nf>Result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>err</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;[%s] error routine[%d], %v&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Format</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>RFC3339Nano</span><span class=p>),</span> <span class=nx>routine</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>eventLogger</span><span class=p>.</span><span class=nf>Append</span><span class=p>(</span><span class=nx>common</span><span class=p>.</span><span class=nx>EventLog</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>EventTime</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>				<span class=nx>Log</span><span class=p>:</span>       <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>			<span class=p>})</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>acquired</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 2. 成功获取
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>eventLogger</span><span class=p>.</span><span class=nf>Append</span><span class=p>(</span><span class=nx>common</span><span class=p>.</span><span class=nx>EventLog</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>EventTime</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>				<span class=nx>Log</span><span class=p>:</span>       <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;[%s] routine[%d] 获取锁&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Format</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>RFC3339Nano</span><span class=p>),</span> <span class=nx>routine</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=p>})</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 3. 模拟业务
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>10</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>eventLogger</span><span class=p>.</span><span class=nf>Append</span><span class=p>(</span><span class=nx>common</span><span class=p>.</span><span class=nx>EventLog</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>EventTime</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>				<span class=nx>Log</span><span class=p>:</span>       <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;[%s] routine[%d] 完成业务逻辑&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Format</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>RFC3339Nano</span><span class=p>),</span> <span class=nx>routine</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=p>})</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 没有获取到锁，等待后重试
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>100</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>ex02ReleaseLock</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>routine</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>eventLogger</span> <span class=o>*</span><span class=nx>common</span><span class=p>.</span><span class=nx>ConcurrentEventLogger</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>routineMark</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>resourceKey</span><span class=p>).</span><span class=nf>Result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>FormatInt</span><span class=p>(</span><span class=nb>int64</span><span class=p>(</span><span class=nx>routine</span><span class=p>),</span> <span class=mi>10</span><span class=p>)</span> <span class=o>!=</span> <span class=nx>routineMark</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 其它协程误删lock
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nb>panic</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;del err lock[%s] can not del by [%d]&#34;</span><span class=p>,</span> <span class=nx>routineMark</span><span class=p>,</span> <span class=nx>routine</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>result</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>Del</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>resourceKey</span><span class=p>).</span><span class=nf>Result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>result</span> <span class=o>==</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>eventLogger</span><span class=p>.</span><span class=nf>Append</span><span class=p>(</span><span class=nx>common</span><span class=p>.</span><span class=nx>EventLog</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>EventTime</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Log</span><span class=p>:</span>       <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;[%s] routine[%d] 释放锁&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Format</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>RFC3339Nano</span><span class=p>),</span> <span class=nx>routine</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>eventLogger</span><span class=p>.</span><span class=nf>Append</span><span class=p>(</span><span class=nx>common</span><span class=p>.</span><span class=nx>EventLog</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>EventTime</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Log</span><span class=p>:</span>       <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;[%s] routine[%d] no lock to del&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Format</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>RFC3339Nano</span><span class=p>),</span> <span class=nx>routine</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;[%s] error routine=%d, %v&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Format</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>RFC3339Nano</span><span class=p>),</span> <span class=nx>routine</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>eventLogger</span><span class=p>.</span><span class=nf>Append</span><span class=p>(</span><span class=nx>common</span><span class=p>.</span><span class=nx>EventLog</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>EventTime</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Log</span><span class=p>:</span>       <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=测试功能go-run-maingo-ex02>测试功能：<code>go run main.go Ex02</code></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>base<span class=o>)</span> ➜  go-redis-example git:<span class=o>(</span>main<span class=o>)</span> go run main.go Ex02
</span></span><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex02
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:27.623764+08:00<span class=o>]</span> routine<span class=o>[</span>9<span class=o>]</span> 获取锁
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:27.634651+08:00<span class=o>]</span> routine<span class=o>[</span>9<span class=o>]</span> 完成业务逻辑
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:27.664945+08:00<span class=o>]</span> routine<span class=o>[</span>9<span class=o>]</span> 释放锁
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:27.743436+08:00<span class=o>]</span> routine<span class=o>[</span>6<span class=o>]</span> 获取锁
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:27.753794+08:00<span class=o>]</span> routine<span class=o>[</span>6<span class=o>]</span> 完成业务逻辑
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:27.754277+08:00<span class=o>]</span> routine<span class=o>[</span>6<span class=o>]</span> 释放锁
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:27.852915+08:00<span class=o>]</span> routine<span class=o>[</span>3<span class=o>]</span> 获取锁
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:27.863014+08:00<span class=o>]</span> routine<span class=o>[</span>3<span class=o>]</span> 完成业务逻辑
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:27.864108+08:00<span class=o>]</span> routine<span class=o>[</span>3<span class=o>]</span> 释放锁
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:27.950776+08:00<span class=o>]</span> routine<span class=o>[</span>5<span class=o>]</span> 获取锁
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:27.961898+08:00<span class=o>]</span> routine<span class=o>[</span>5<span class=o>]</span> 完成业务逻辑
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:27.96241+08:00<span class=o>]</span> routine<span class=o>[</span>5<span class=o>]</span> 释放锁
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:28.052261+08:00<span class=o>]</span> routine<span class=o>[</span>2<span class=o>]</span> 获取锁
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:28.062988+08:00<span class=o>]</span> routine<span class=o>[</span>2<span class=o>]</span> 完成业务逻辑
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:28.063701+08:00<span class=o>]</span> routine<span class=o>[</span>2<span class=o>]</span> 释放锁
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:28.152431+08:00<span class=o>]</span> routine<span class=o>[</span>0<span class=o>]</span> 获取锁
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:28.162493+08:00<span class=o>]</span> routine<span class=o>[</span>0<span class=o>]</span> 完成业务逻辑
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:28.162897+08:00<span class=o>]</span> routine<span class=o>[</span>0<span class=o>]</span> 释放锁
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:28.253946+08:00<span class=o>]</span> routine<span class=o>[</span>7<span class=o>]</span> 获取锁
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:28.264098+08:00<span class=o>]</span> routine<span class=o>[</span>7<span class=o>]</span> 完成业务逻辑
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:28.264486+08:00<span class=o>]</span> routine<span class=o>[</span>7<span class=o>]</span> 释放锁
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:28.354901+08:00<span class=o>]</span> routine<span class=o>[</span>4<span class=o>]</span> 获取锁
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:28.365065+08:00<span class=o>]</span> routine<span class=o>[</span>4<span class=o>]</span> 完成业务逻辑
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:28.36569+08:00<span class=o>]</span> routine<span class=o>[</span>4<span class=o>]</span> 释放锁
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:28.458786+08:00<span class=o>]</span> routine<span class=o>[</span>8<span class=o>]</span> 获取锁
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:28.469094+08:00<span class=o>]</span> routine<span class=o>[</span>8<span class=o>]</span> 完成业务逻辑
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:28.471307+08:00<span class=o>]</span> routine<span class=o>[</span>8<span class=o>]</span> 释放锁
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:28.560792+08:00<span class=o>]</span> routine<span class=o>[</span>1<span class=o>]</span> 获取锁
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:28.584265+08:00<span class=o>]</span> routine<span class=o>[</span>1<span class=o>]</span> 完成业务逻辑
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:53:28.618252+08:00<span class=o>]</span> routine<span class=o>[</span>1<span class=o>]</span> 释放锁
</span></span></code></pre></td></tr></table></div></div><h2 id=03-基于incr和decr的简单限流器>03-基于<code>Incr</code>和<code>Decr</code>的简单限流器</h2><p>要求 1s 内放行的请求为 N，超过 N 的请求次数则禁止访问。</p><p>通过 redis 的 string 类型，对 key 进行 <code>Incr</code> 和 <code>Decr</code> 操作。value 与 N 比对，判断是否放行。</p><h3 id=代码实现-2>代码实现</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>example</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;sync/atomic&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;go-redis-example/common&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Ex03Params</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>ex03LimitKeyPreFix</span> <span class=p>=</span> <span class=s>&#34;common_freq_limit&#34;</span> <span class=c1>// 限流key前缀
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ex03MaxQPS</span>         <span class=p>=</span> <span class=mi>10</span>                  <span class=c1>// 限流次数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>accessQueryNum</span> <span class=p>=</span> <span class=nb>int32</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 返回key格式为：comment_freq_limit-1669524458,
</span></span></span><span class=line><span class=cl><span class=c1>// 用来记录这1秒内的请求数量
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>ex03LimitKey</span><span class=p>(</span><span class=nx>currentTimeStamp</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s-%d&#34;</span><span class=p>,</span> <span class=nx>ex03LimitKeyPreFix</span><span class=p>,</span> <span class=nx>currentTimeStamp</span><span class=p>.</span><span class=nf>Unix</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Ex03 简单限流
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>Ex03</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>eventLogger</span> <span class=o>:=</span> <span class=nx>common</span><span class=p>.</span><span class=nf>NewConcurrentEventLog</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// new一个并发执行器
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cInst</span> <span class=o>:=</span> <span class=nx>common</span><span class=p>.</span><span class=nf>NewConcurrentRoutine</span><span class=p>(</span><span class=mi>500</span><span class=p>,</span> <span class=nx>eventLogger</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 并发执行自定义函数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cInst</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>Ex03Params</span><span class=p>{},</span> <span class=nx>ex03Work</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 输出日志
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>eventLogger</span><span class=p>.</span><span class=nf>PrintLogs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;放行总数：%d&#34;</span><span class=p>,</span> <span class=nx>accessQueryNum</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>1</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;\n------\n下一秒请求\n------\n&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 清空日志信息
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>eventLogger</span> <span class=p>=</span> <span class=nx>common</span><span class=p>.</span><span class=nf>NewConcurrentEventLog</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>accessQueryNum</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=c1>// new一个并发执行器
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cInst</span> <span class=p>=</span> <span class=nx>common</span><span class=p>.</span><span class=nf>NewConcurrentRoutine</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=nx>eventLogger</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 并发执行用户自定义函数work
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cInst</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>Ex03Params</span><span class=p>{},</span> <span class=nx>ex03Work</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 按日志时间正序打印日志
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>eventLogger</span><span class=p>.</span><span class=nf>PrintLogs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;放行总数：%d&#34;</span><span class=p>,</span> <span class=nx>accessQueryNum</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>ex03Work</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>cInstParams</span> <span class=nx>common</span><span class=p>.</span><span class=nx>CInstParams</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>routine</span> <span class=o>:=</span> <span class=nx>cInstParams</span><span class=p>.</span><span class=nx>Routine</span>
</span></span><span class=line><span class=cl>	<span class=nx>eventLogger</span> <span class=o>:=</span> <span class=nx>cInstParams</span><span class=p>.</span><span class=nx>ConcurrentEventLogger</span>
</span></span><span class=line><span class=cl>	<span class=nx>key</span> <span class=o>:=</span> <span class=nf>ex03LimitKey</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=nx>currentQPS</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>Incr</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>key</span><span class=p>).</span><span class=nf>Result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>currentQPS</span> <span class=p>&gt;</span> <span class=nx>ex03MaxQPS</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 超过流量限制，请求受限
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>eventLogger</span><span class=p>.</span><span class=nf>Append</span><span class=p>(</span><span class=nx>common</span><span class=p>.</span><span class=nx>EventLog</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>EventTime</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Log</span><span class=p>:</span>       <span class=nx>common</span><span class=p>.</span><span class=nf>LogFormat</span><span class=p>(</span><span class=nx>routine</span><span class=p>,</span> <span class=s>&#34;被限流[%d]&#34;</span><span class=p>,</span> <span class=nx>currentQPS</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=c1>// sleep模拟业务耗时
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>50</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>Decr</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>key</span><span class=p>).</span><span class=nf>Err</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 流量放行
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>eventLogger</span><span class=p>.</span><span class=nf>Append</span><span class=p>(</span><span class=nx>common</span><span class=p>.</span><span class=nx>EventLog</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>EventTime</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Log</span><span class=p>:</span>       <span class=nx>common</span><span class=p>.</span><span class=nf>LogFormat</span><span class=p>(</span><span class=nx>routine</span><span class=p>,</span> <span class=s>&#34;流量放行[%d]&#34;</span><span class=p>,</span> <span class=nx>currentQPS</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=nx>atomic</span><span class=p>.</span><span class=nf>AddInt32</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>accessQueryNum</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>20</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=测试功能go-run-maingo-ex03>测试功能：<code>go run main.go Ex03</code></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>base<span class=o>)</span> ➜  go-redis-example git:<span class=o>(</span>main<span class=o>)</span> ✗ go run main.go Ex03
</span></span><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex03
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:52.869876+08:00<span class=o>]</span> routine<span class=o>[</span>2<span class=o>]</span> 流量放行<span class=o>[</span>1<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:52.87983+08:00<span class=o>]</span> routine<span class=o>[</span>32<span class=o>]</span> 流量放行<span class=o>[</span>2<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:52.881233+08:00<span class=o>]</span> routine<span class=o>[</span>33<span class=o>]</span> 流量放行<span class=o>[</span>5<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:52.881636+08:00<span class=o>]</span> routine<span class=o>[</span>6<span class=o>]</span> 流量放行<span class=o>[</span>4<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:52.88164+08:00<span class=o>]</span> routine<span class=o>[</span>36<span class=o>]</span> 流量放行<span class=o>[</span>3<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:52.881844+08:00<span class=o>]</span> routine<span class=o>[</span>25<span class=o>]</span> 被限流<span class=o>[</span>40<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:52.881856+08:00<span class=o>]</span> routine<span class=o>[</span>8<span class=o>]</span> 被限流<span class=o>[</span>42<span class=o>]</span>
</span></span><span class=line><span class=cl>···
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:52.894559+08:00<span class=o>]</span> routine<span class=o>[</span>448<span class=o>]</span> 被限流<span class=o>[</span>490<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:52.894576+08:00<span class=o>]</span> routine<span class=o>[</span>442<span class=o>]</span> 被限流<span class=o>[</span>491<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:52.894657+08:00<span class=o>]</span> routine<span class=o>[</span>450<span class=o>]</span> 被限流<span class=o>[</span>488<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:52.894666+08:00<span class=o>]</span> routine<span class=o>[</span>451<span class=o>]</span> 被限流<span class=o>[</span>489<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:52.894673+08:00<span class=o>]</span> routine<span class=o>[</span>444<span class=o>]</span> 被限流<span class=o>[</span>487<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:52.89473+08:00<span class=o>]</span> routine<span class=o>[</span>498<span class=o>]</span> 被限流<span class=o>[</span>486<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:52.89475+08:00<span class=o>]</span> routine<span class=o>[</span>443<span class=o>]</span> 被限流<span class=o>[</span>485<span class=o>]</span>
</span></span><span class=line><span class=cl>2024/03/26 15:59:52 放行总数：10
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>------
</span></span><span class=line><span class=cl>下一秒请求
</span></span><span class=line><span class=cl>------
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:53.977507+08:00<span class=o>]</span> routine<span class=o>[</span>1<span class=o>]</span> 流量放行<span class=o>[</span>10<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:53.977535+08:00<span class=o>]</span> routine<span class=o>[</span>3<span class=o>]</span> 流量放行<span class=o>[</span>9<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:53.977601+08:00<span class=o>]</span> routine<span class=o>[</span>2<span class=o>]</span> 流量放行<span class=o>[</span>8<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:53.977656+08:00<span class=o>]</span> routine<span class=o>[</span>8<span class=o>]</span> 流量放行<span class=o>[</span>7<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:53.977743+08:00<span class=o>]</span> routine<span class=o>[</span>6<span class=o>]</span> 流量放行<span class=o>[</span>4<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:53.977752+08:00<span class=o>]</span> routine<span class=o>[</span>7<span class=o>]</span> 流量放行<span class=o>[</span>5<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:53.977759+08:00<span class=o>]</span> routine<span class=o>[</span>0<span class=o>]</span> 流量放行<span class=o>[</span>6<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:53.977772+08:00<span class=o>]</span> routine<span class=o>[</span>9<span class=o>]</span> 流量放行<span class=o>[</span>1<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:53.977781+08:00<span class=o>]</span> routine<span class=o>[</span>5<span class=o>]</span> 流量放行<span class=o>[</span>3<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T15:59:53.977785+08:00<span class=o>]</span> routine<span class=o>[</span>4<span class=o>]</span> 流量放行<span class=o>[</span>2<span class=o>]</span>
</span></span><span class=line><span class=cl>2024/03/26 15:59:53 放行总数：10
</span></span></code></pre></td></tr></table></div></div><h2 id=04-基于list的消息队列>04-基于<code>List</code>的消息队列</h2><div class="details admonition info open"><div class="details-summary admonition-title"><i class="icon fas fa-info-circle fa-fw" aria-hidden=true></i>消息队列的定义<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><ol><li>消息队列是一种先进先出的队列型数据结构。消息被顺序插入队列中，其中发送进程将消息添加到队列末尾，接受进程从队列头读取消息。</li><li>多个进程可同时向一个消息队列发送消息，也可以同时从一个消息队列中接收消息。发送进程把消息发送到队列尾部，接受进程从消息队列头部读取消息，消息一旦被读出就从队列中删除。</li></ol></div></div></div><p>使用 redis 的 List 的 <code>lpush</code> 和 <code>rpop</code> 可以实现一个简易的消息队列。</p><h3 id=代码实现-3>代码实现</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>example</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;strings&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/redis/go-redis/v9&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;go-redis-example/common&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=nx>ex04ListenList</span> <span class=p>=</span> <span class=s>&#34;ex04_list_0&#34;</span> <span class=c1>// lpush ex04_list_0 AA BB
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Ex04Params Ex04的自定义函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Ex04Params</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Ex04</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>eventLogger</span> <span class=o>:=</span> <span class=nx>common</span><span class=p>.</span><span class=nf>NewConcurrentEventLog</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// new一个并发执行器
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// routineNums是消费端的数量，多消费的场景，可以使用ex04ConsumerPop，使用ex04ConsumerRange存在消息重复消费的问题。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cInst</span> <span class=o>:=</span> <span class=nx>common</span><span class=p>.</span><span class=nf>NewConcurrentRoutine</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=nx>eventLogger</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nx>cInst</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>Ex04Params</span><span class=p>{},</span> <span class=nx>ex04ProducerPush</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 并发执行用户自定义函数work
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cInst</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>Ex04Params</span><span class=p>{},</span> <span class=nx>ex04ConsumerPop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 按日志时间正序打印日志
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>eventLogger</span><span class=p>.</span><span class=nf>PrintLogs</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>ex04ProducerPush</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>cInstParam</span> <span class=nx>common</span><span class=p>.</span><span class=nx>CInstParams</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>routine</span> <span class=o>:=</span> <span class=nx>cInstParam</span><span class=p>.</span><span class=nx>Routine</span>
</span></span><span class=line><span class=cl>	<span class=nx>cnt</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>RedisCli</span><span class=p>.</span><span class=nf>LPush</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>ex04ListenList</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;producer[%d] push %d&#34;</span><span class=p>,</span> <span class=nx>routine</span><span class=p>,</span> <span class=nx>cnt</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>cnt</span> <span class=p>&gt;</span> <span class=mi>3</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>cnt</span><span class=o>++</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ex04ConsumerPop 使用rpop逐条消费队列中的信息，数据从队列中移除
</span></span></span><span class=line><span class=cl><span class=c1>// 生成端使用：lpush ex04_list_0 AA BB
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>ex04ConsumerPop</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>cInstParam</span> <span class=nx>common</span><span class=p>.</span><span class=nx>CInstParams</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>routine</span> <span class=o>:=</span> <span class=nx>cInstParam</span><span class=p>.</span><span class=nx>Routine</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>items</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>BRPop</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span> <span class=nx>ex04ListenList</span><span class=p>).</span><span class=nf>Result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>redis</span><span class=p>.</span><span class=nx>Nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>common</span><span class=p>.</span><span class=nf>LogFormat</span><span class=p>(</span><span class=nx>routine</span><span class=p>,</span> <span class=s>&#34;任务执行结束&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>common</span><span class=p>.</span><span class=nf>LogFormat</span><span class=p>(</span><span class=nx>routine</span><span class=p>,</span> <span class=s>&#34;读取文章[%s]标题、正文，发送到ES更新索引&#34;</span><span class=p>,</span> <span class=nx>items</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 将文章内容推送到ES
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>1</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ex04ConsumerRange 使用lrange批量消费队列中的数据，数据保留在队列中
</span></span></span><span class=line><span class=cl><span class=c1>// 生成端使用：rpush ex04_list_0 AA BB
</span></span></span><span class=line><span class=cl><span class=c1>// 消费端：
</span></span></span><span class=line><span class=cl><span class=c1>// 方法1 lrange ex04_list_0 -3 -1 // 从FIFO队尾中一次消费3条信息
</span></span></span><span class=line><span class=cl><span class=c1>// 方法2 rpop ex04_list_0 3
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>ex04ConsumerRange</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>cInstParam</span> <span class=nx>common</span><span class=p>.</span><span class=nx>CInstParams</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>routine</span> <span class=o>:=</span> <span class=nx>cInstParam</span><span class=p>.</span><span class=nx>Routine</span>
</span></span><span class=line><span class=cl>	<span class=nx>consumeBatchSize</span> <span class=o>:=</span> <span class=nb>int64</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span> <span class=c1>// 一次取N个消息
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 从index(-consumeBatchSize)开始取，直到最后一个元素index(-1)
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>items</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>LRange</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>ex04ListenList</span><span class=p>,</span> <span class=o>-</span><span class=nx>consumeBatchSize</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>).</span><span class=nf>Result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>items</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>common</span><span class=p>.</span><span class=nf>LogFormat</span><span class=p>(</span><span class=nx>routine</span><span class=p>,</span> <span class=s>&#34;收到信息:%s&#34;</span><span class=p>,</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>items</span><span class=p>,</span> <span class=s>&#34;-&gt;&#34;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 清除已消费的队列
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// 方法1 使用LTrim
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// 保留从index(0)开始到index(-(consumeBatchSize + 1))的部分，即为未消费的部分
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// RedisCli.LTrim(ctx, ex04ListenList, 0, -(consumeBatchSize + 1))
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>			<span class=c1>// 方法2 使用RPop
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>RedisCli</span><span class=p>.</span><span class=nf>RPopCount</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>ex04ListenList</span><span class=p>,</span> <span class=nb>int</span><span class=p>(</span><span class=nx>consumeBatchSize</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>3</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=测试功能go-run-maingo-ex04>测试功能：<code>go run main.go Ex04</code></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>base<span class=o>)</span> ➜  go-redis-example git:<span class=o>(</span>main<span class=o>)</span> ✗ go run main.go Ex04
</span></span><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex04
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T16:18:35.394455+08:00<span class=o>]</span> routine<span class=o>[</span>1<span class=o>]</span> 读取文章<span class=o>[</span>producer<span class=o>[</span>1<span class=o>]</span> push 0<span class=o>]</span>标题、正文，发送到ES更新索引
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T16:18:35.396198+08:00<span class=o>]</span> routine<span class=o>[</span>2<span class=o>]</span> 读取文章<span class=o>[</span>producer<span class=o>[</span>0<span class=o>]</span> push 0<span class=o>]</span>标题、正文，发送到ES更新索引
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T16:18:35.396556+08:00<span class=o>]</span> routine<span class=o>[</span>0<span class=o>]</span> 读取文章<span class=o>[</span>producer<span class=o>[</span>0<span class=o>]</span> push 1<span class=o>]</span>标题、正文，发送到ES更新索引
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T16:18:36.397106+08:00<span class=o>]</span> routine<span class=o>[</span>1<span class=o>]</span> 读取文章<span class=o>[</span>producer<span class=o>[</span>0<span class=o>]</span> push 2<span class=o>]</span>标题、正文，发送到ES更新索引
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T16:18:36.397123+08:00<span class=o>]</span> routine<span class=o>[</span>2<span class=o>]</span> 读取文章<span class=o>[</span>producer<span class=o>[</span>2<span class=o>]</span> push 0<span class=o>]</span>标题、正文，发送到ES更新索引
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T16:18:36.39716+08:00<span class=o>]</span> routine<span class=o>[</span>0<span class=o>]</span> 读取文章<span class=o>[</span>producer<span class=o>[</span>1<span class=o>]</span> push 1<span class=o>]</span>标题、正文，发送到ES更新索引
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T16:18:37.398938+08:00<span class=o>]</span> routine<span class=o>[</span>2<span class=o>]</span> 读取文章<span class=o>[</span>producer<span class=o>[</span>1<span class=o>]</span> push 2<span class=o>]</span>标题、正文，发送到ES更新索引
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T16:18:37.398954+08:00<span class=o>]</span> routine<span class=o>[</span>0<span class=o>]</span> 读取文章<span class=o>[</span>producer<span class=o>[</span>2<span class=o>]</span> push 1<span class=o>]</span>标题、正文，发送到ES更新索引
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T16:18:37.398978+08:00<span class=o>]</span> routine<span class=o>[</span>1<span class=o>]</span> 读取文章<span class=o>[</span>producer<span class=o>[</span>1<span class=o>]</span> push 3<span class=o>]</span>标题、正文，发送到ES更新索引
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T16:18:38.399928+08:00<span class=o>]</span> routine<span class=o>[</span>2<span class=o>]</span> 读取文章<span class=o>[</span>producer<span class=o>[</span>2<span class=o>]</span> push 3<span class=o>]</span>标题、正文，发送到ES更新索引
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T16:18:38.399967+08:00<span class=o>]</span> routine<span class=o>[</span>1<span class=o>]</span> 读取文章<span class=o>[</span>producer<span class=o>[</span>2<span class=o>]</span> push 2<span class=o>]</span>标题、正文，发送到ES更新索引
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T16:18:38.399979+08:00<span class=o>]</span> routine<span class=o>[</span>0<span class=o>]</span> 读取文章<span class=o>[</span>producer<span class=o>[</span>1<span class=o>]</span> push 4<span class=o>]</span>标题、正文，发送到ES更新索引
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T16:18:39.401791+08:00<span class=o>]</span> routine<span class=o>[</span>2<span class=o>]</span> 读取文章<span class=o>[</span>producer<span class=o>[</span>0<span class=o>]</span> push 4<span class=o>]</span>标题、正文，发送到ES更新索引
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T16:18:39.401869+08:00<span class=o>]</span> routine<span class=o>[</span>1<span class=o>]</span> 读取文章<span class=o>[</span>producer<span class=o>[</span>2<span class=o>]</span> push 4<span class=o>]</span>标题、正文，发送到ES更新索引
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T16:18:39.401923+08:00<span class=o>]</span> routine<span class=o>[</span>0<span class=o>]</span> 读取文章<span class=o>[</span>producer<span class=o>[</span>0<span class=o>]</span> push 3<span class=o>]</span>标题、正文，发送到ES更新索引
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T16:18:41.463624+08:00<span class=o>]</span> routine<span class=o>[</span>0<span class=o>]</span> 任务执行结束
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T16:18:41.463655+08:00<span class=o>]</span> routine<span class=o>[</span>1<span class=o>]</span> 任务执行结束
</span></span><span class=line><span class=cl><span class=o>[</span>2024-03-26T16:18:41.46367+08:00<span class=o>]</span> routine<span class=o>[</span>2<span class=o>]</span> 任务执行结束
</span></span></code></pre></td></tr></table></div></div><h2 id=05-基于hash的计数器>05-基于<code>Hash</code>的计数器</h2><p>对于一个用户有多个计数需求，例如点赞数量、粉丝数量、文章收藏数量、关注数量等，可以使用 Hash 的数据结构进行存储。</p><h3 id=代码实现-4>代码实现</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>example</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;strconv&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=nx>ex05UserCountKey</span> <span class=p>=</span> <span class=s>&#34;ex05_user_count&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Ex05 hash数据结果的运用（参考掘金应用）
</span></span></span><span class=line><span class=cl><span class=c1>// go run main.go Ex05 init 初始化用户计数值
</span></span></span><span class=line><span class=cl><span class=c1>// go run main.go Ex05 get 1556564194374926  // 打印用户(1556564194374926)的所有计数值
</span></span></span><span class=line><span class=cl><span class=c1>// go run main.go Ex05 incr_like 1556564194374926 // 点赞数+1
</span></span></span><span class=line><span class=cl><span class=c1>// go run main.go Ex05 incr_collect 1556564194374926 // 收藏数+1
</span></span></span><span class=line><span class=cl><span class=c1>// go run main.go Ex05 decr_like 1556564194374926 // 点赞数-1
</span></span></span><span class=line><span class=cl><span class=c1>// go run main.go Ex05 decr_collect 1556564194374926 // 收藏数-1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>Ex05</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>args</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;args can&#39;t be empty&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>arg1</span> <span class=o>:=</span> <span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=nx>arg1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;init&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nf>Ex05InitUserCount</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;get&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>userID</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseInt</span><span class=p>(</span><span class=nx>args</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nf>Ex05GetUserCount</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>userID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;incr_like&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>userID</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseInt</span><span class=p>(</span><span class=nx>args</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nf>IncrByUserLike</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>userID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;incr_collect&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>userID</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseInt</span><span class=p>(</span><span class=nx>args</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nf>IncrByUserCollect</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>userID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;decr_like&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>userID</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseInt</span><span class=p>(</span><span class=nx>args</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nf>DecrByUserLike</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>userID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;decr_collect&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>userID</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseInt</span><span class=p>(</span><span class=nx>args</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nf>DecrByUserCollect</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>userID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;do not support now...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Ex05InitUserCount</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>pipe</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>Pipeline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>userCounters</span> <span class=o>:=</span> <span class=p>[]</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span><span class=s>&#34;user_id&#34;</span><span class=p>:</span> <span class=s>&#34;1556564194374926&#34;</span><span class=p>,</span> <span class=s>&#34;got_digg_count&#34;</span><span class=p>:</span> <span class=mi>10693</span><span class=p>,</span> <span class=s>&#34;got_view_count&#34;</span><span class=p>:</span> <span class=mi>2238438</span><span class=p>,</span> <span class=s>&#34;followee_count&#34;</span><span class=p>:</span> <span class=mi>176</span><span class=p>,</span> <span class=s>&#34;follower_count&#34;</span><span class=p>:</span> <span class=mi>9895</span><span class=p>,</span> <span class=s>&#34;follow_collect_set_count&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;subscribe_tag_count&#34;</span><span class=p>:</span> <span class=mi>95</span><span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span><span class=s>&#34;user_id&#34;</span><span class=p>:</span> <span class=s>&#34;1111&#34;</span><span class=p>,</span> <span class=s>&#34;got_digg_count&#34;</span><span class=p>:</span> <span class=mi>19</span><span class=p>,</span> <span class=s>&#34;got_view_count&#34;</span><span class=p>:</span> <span class=mi>4</span><span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span><span class=s>&#34;user_id&#34;</span><span class=p>:</span> <span class=s>&#34;2222&#34;</span><span class=p>,</span> <span class=s>&#34;got_digg_count&#34;</span><span class=p>:</span> <span class=mi>1238</span><span class=p>,</span> <span class=s>&#34;follower_count&#34;</span><span class=p>:</span> <span class=mi>379</span><span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>counter</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>userCounters</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>uid</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseInt</span><span class=p>(</span><span class=nx>counter</span><span class=p>[</span><span class=s>&#34;user_id&#34;</span><span class=p>].(</span><span class=kt>string</span><span class=p>),</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>key</span> <span class=o>:=</span> <span class=nf>ex05GetUserCounterKey</span><span class=p>(</span><span class=nx>uid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>pipe</span><span class=p>.</span><span class=nf>Del</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>key</span><span class=p>).</span><span class=nf>Err</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>pipe</span><span class=p>.</span><span class=nf>HMSet</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>counter</span><span class=p>).</span><span class=nf>Err</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;设置uid[%d], key=%s&#34;</span><span class=p>,</span> <span class=nx>uid</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>pipe</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=nx>ctx</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 再执行一次
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>pipe</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=nx>ctx</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ex05GetUserCounterKey 获取用户计数的key
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>ex05GetUserCounterKey</span><span class=p>(</span><span class=nx>userID</span> <span class=kt>int64</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s_%d&#34;</span><span class=p>,</span> <span class=nx>ex05UserCountKey</span><span class=p>,</span> <span class=nx>userID</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Ex05GetUserCount</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>userID</span> <span class=kt>int64</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>pipe</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>Pipeline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>pipe</span><span class=p>.</span><span class=nf>HGetAll</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nf>ex05GetUserCounterKey</span><span class=p>(</span><span class=nx>userID</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>results</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>HGetAll</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nf>ex05GetUserCounterKey</span><span class=p>(</span><span class=nx>userID</span><span class=p>)).</span><span class=nf>Result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;User[%d]:\n&#34;</span><span class=p>,</span> <span class=nx>userID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>k</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>results</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%s: %s\n&#34;</span><span class=p>,</span> <span class=nx>k</span><span class=p>,</span> <span class=nx>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// IncrByUserLike 点赞数+1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>IncrByUserLike</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>userID</span> <span class=kt>int64</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>incrByUserField</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>userID</span><span class=p>,</span> <span class=s>&#34;got_digg_count&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// IncrByUserCollect 收藏数+1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>IncrByUserCollect</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>userID</span> <span class=kt>int64</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>incrByUserField</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>userID</span><span class=p>,</span> <span class=s>&#34;follow_collect_set_count&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// DecrByUserLike 点赞数-1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>DecrByUserLike</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>userID</span> <span class=kt>int64</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>decrByUserField</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>userID</span><span class=p>,</span> <span class=s>&#34;got_digg_count&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// DecrByUserCollect 收藏数-1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>DecrByUserCollect</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>userID</span> <span class=kt>int64</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>decrByUserField</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>userID</span><span class=p>,</span> <span class=s>&#34;follow_collect_set_count&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>incrByUserField</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>userID</span> <span class=kt>int64</span><span class=p>,</span> <span class=nx>field</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>change</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>userID</span><span class=p>,</span> <span class=nx>field</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>decrByUserField</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>userID</span> <span class=kt>int64</span><span class=p>,</span> <span class=nx>field</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>change</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>userID</span><span class=p>,</span> <span class=nx>field</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>change</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>userID</span> <span class=kt>int64</span><span class=p>,</span> <span class=nx>field</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>delta</span> <span class=kt>int64</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>key</span> <span class=o>:=</span> <span class=nf>ex05GetUserCounterKey</span><span class=p>(</span><span class=nx>userID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>before</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>HGet</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>field</span><span class=p>).</span><span class=nf>Result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>beforeInt</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseInt</span><span class=p>(</span><span class=nx>before</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>beforeInt</span><span class=o>+</span><span class=nx>delta</span> <span class=p>&lt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;禁止变更计数，计数变更后小于0. %d + (%d) = %d\n&#34;</span><span class=p>,</span> <span class=nx>beforeInt</span><span class=p>,</span> <span class=nx>delta</span><span class=p>,</span> <span class=nx>beforeInt</span><span class=o>+</span><span class=nx>delta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;user[%d]: \n更新前\n%s = %s\n--------\n&#34;</span><span class=p>,</span> <span class=nx>userID</span><span class=p>,</span> <span class=nx>field</span><span class=p>,</span> <span class=nx>before</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>HIncrBy</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>field</span><span class=p>,</span> <span class=nx>delta</span><span class=p>).</span><span class=nf>Err</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>count</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>HGet</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>field</span><span class=p>).</span><span class=nf>Result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;user_id: %d\n更新后\n%s = %s\n--------\n&#34;</span><span class=p>,</span> <span class=nx>userID</span><span class=p>,</span> <span class=nx>field</span><span class=p>,</span> <span class=nx>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=测试功能>测试功能</h3><p>测试脚本：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>go run main.go Ex05 init <span class=c1># 初始化用户计数值</span>
</span></span><span class=line><span class=cl>go run main.go Ex05 get <span class=m>1556564194374926</span>  <span class=c1># 打印用户(1556564194374926)的所有计数值</span>
</span></span><span class=line><span class=cl>go run main.go Ex05 incr_like <span class=m>1556564194374926</span> <span class=c1># 点赞数+1</span>
</span></span><span class=line><span class=cl>go run main.go Ex05 incr_collect <span class=m>1556564194374926</span> <span class=c1># 收藏数+1</span>
</span></span><span class=line><span class=cl>go run main.go Ex05 decr_like <span class=m>1556564194374926</span> <span class=c1># 点赞数-1</span>
</span></span><span class=line><span class=cl>go run main.go Ex05 decr_collect <span class=m>1556564194374926</span> <span class=c1># 收藏数-1</span>
</span></span><span class=line><span class=cl>go run main.go Ex05 decr_collect <span class=m>1556564194374926</span> <span class=c1># 收藏数-1</span>
</span></span></code></pre></td></tr></table></div></div><p>执行结果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex05
</span></span><span class=line><span class=cl>init
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl>设置uid<span class=o>[</span>1556564194374926<span class=o>]</span>, <span class=nv>key</span><span class=o>=</span>ex05_user_count_1556564194374926
</span></span><span class=line><span class=cl>设置uid<span class=o>[</span>1111<span class=o>]</span>, <span class=nv>key</span><span class=o>=</span>ex05_user_count_1111
</span></span><span class=line><span class=cl>设置uid<span class=o>[</span>2222<span class=o>]</span>, <span class=nv>key</span><span class=o>=</span>ex05_user_count_2222
</span></span><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex05
</span></span><span class=line><span class=cl>get
</span></span><span class=line><span class=cl><span class=m>1556564194374926</span>
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl>User<span class=o>[</span>1556564194374926<span class=o>]</span>:
</span></span><span class=line><span class=cl>got_view_count: <span class=m>2238438</span>
</span></span><span class=line><span class=cl>followee_count: <span class=m>176</span>
</span></span><span class=line><span class=cl>follower_count: <span class=m>9895</span>
</span></span><span class=line><span class=cl>follow_collect_set_count: <span class=m>0</span>
</span></span><span class=line><span class=cl>subscribe_tag_count: <span class=m>95</span>
</span></span><span class=line><span class=cl>user_id: <span class=m>1556564194374926</span>
</span></span><span class=line><span class=cl>got_digg_count: <span class=m>10693</span>
</span></span><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex05
</span></span><span class=line><span class=cl>incr_like
</span></span><span class=line><span class=cl><span class=m>1556564194374926</span>
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl>user<span class=o>[</span>1556564194374926<span class=o>]</span>:
</span></span><span class=line><span class=cl>更新前
</span></span><span class=line><span class=cl><span class=nv>got_digg_count</span> <span class=o>=</span> <span class=m>10693</span>
</span></span><span class=line><span class=cl>--------
</span></span><span class=line><span class=cl>user_id: <span class=m>1556564194374926</span>
</span></span><span class=line><span class=cl>更新后
</span></span><span class=line><span class=cl><span class=nv>got_digg_count</span> <span class=o>=</span> <span class=m>10694</span>
</span></span><span class=line><span class=cl>--------
</span></span><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex05
</span></span><span class=line><span class=cl>incr_collect
</span></span><span class=line><span class=cl><span class=m>1556564194374926</span>
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl>user<span class=o>[</span>1556564194374926<span class=o>]</span>:
</span></span><span class=line><span class=cl>更新前
</span></span><span class=line><span class=cl><span class=nv>follow_collect_set_count</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>--------
</span></span><span class=line><span class=cl>user_id: <span class=m>1556564194374926</span>
</span></span><span class=line><span class=cl>更新后
</span></span><span class=line><span class=cl><span class=nv>follow_collect_set_count</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>--------
</span></span><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex05
</span></span><span class=line><span class=cl>decr_like
</span></span><span class=line><span class=cl><span class=m>1556564194374926</span>
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl>user<span class=o>[</span>1556564194374926<span class=o>]</span>:
</span></span><span class=line><span class=cl>更新前
</span></span><span class=line><span class=cl><span class=nv>got_digg_count</span> <span class=o>=</span> <span class=m>10694</span>
</span></span><span class=line><span class=cl>--------
</span></span><span class=line><span class=cl>user_id: <span class=m>1556564194374926</span>
</span></span><span class=line><span class=cl>更新后
</span></span><span class=line><span class=cl><span class=nv>got_digg_count</span> <span class=o>=</span> <span class=m>10693</span>
</span></span><span class=line><span class=cl>--------
</span></span><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex05
</span></span><span class=line><span class=cl>decr_collect
</span></span><span class=line><span class=cl><span class=m>1556564194374926</span>
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl>user<span class=o>[</span>1556564194374926<span class=o>]</span>:
</span></span><span class=line><span class=cl>更新前
</span></span><span class=line><span class=cl><span class=nv>follow_collect_set_count</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>--------
</span></span><span class=line><span class=cl>user_id: <span class=m>1556564194374926</span>
</span></span><span class=line><span class=cl>更新后
</span></span><span class=line><span class=cl><span class=nv>follow_collect_set_count</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>--------
</span></span><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex05
</span></span><span class=line><span class=cl>decr_collect
</span></span><span class=line><span class=cl><span class=m>1556564194374926</span>
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl>禁止变更计数，计数变更后小于0. <span class=m>0</span> + <span class=o>(</span>-1<span class=o>)</span> <span class=o>=</span> -1
</span></span></code></pre></td></tr></table></div></div><h2 id=06-基于zset的排行榜>06-基于<code>Zset</code>的排行榜</h2><p>积分榜变化时，排名要实时改变。通过 Zset 可以很好的实现功能</p><h3 id=代码实现-5>代码实现</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>example</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;strconv&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/redis/go-redis/v9&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=nx>ex06RankKey</span> <span class=p>=</span> <span class=s>&#34;ex06_rank_zset&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ex06ItemScore</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>ItemName</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>Score</span>    <span class=kt>float64</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Ex06 排行榜
</span></span></span><span class=line><span class=cl><span class=c1>// go run main.go Ex06 init // 初始化积分
</span></span></span><span class=line><span class=cl><span class=c1>// go run main.go Ex06 rev_order // 输出完整榜单
</span></span></span><span class=line><span class=cl><span class=c1>// go run main.go Ex06 order_page 1 // 逆序分页输出，page=1
</span></span></span><span class=line><span class=cl><span class=c1>// go run main.go Ex06 get_rank user2 // 获取user2的排名
</span></span></span><span class=line><span class=cl><span class=c1>// go run main.go Ex06 get_score user2 // 获取user2的分数
</span></span></span><span class=line><span class=cl><span class=c1>// go run main.go Ex06 add_user_score user2 10 // 为user2设置为10分
</span></span></span><span class=line><span class=cl><span class=c1>// zadd ex06_rank_zset 15 andy
</span></span></span><span class=line><span class=cl><span class=c1>// zincrby ex06_rank_zset -9 andy // andy 扣9分，排名掉到最后一名
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>Ex06</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>arg1</span> <span class=o>:=</span> <span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=nx>arg1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;init&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nf>ex06Init</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;rev_order&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nf>ex06GetOrderListAll</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;order_page&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>pageSize</span> <span class=o>:=</span> <span class=nb>int64</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>args</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>offset</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseInt</span><span class=p>(</span><span class=nx>args</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nf>ex06GetOrderListByPage</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>offset</span><span class=p>,</span> <span class=nx>pageSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;get_rank&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nf>ex06GetUserRankByName</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>args</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;get_score&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nf>ex06GetUserScoreByName</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>args</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;add_user_score&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>args</span><span class=p>)</span> <span class=p>&lt;</span> <span class=mi>3</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;参数错误，可能是缺少需要增加的分值。eg：go run main.go  Ex06 add_user_score user2 10\n&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>score</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseFloat</span><span class=p>(</span><span class=nx>args</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nf>ex06AddUserScore</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>args</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>score</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;unsupported type&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>ex06Init</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>initList</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>redis</span><span class=p>.</span><span class=nx>Z</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span><span class=nx>Member</span><span class=p>:</span> <span class=s>&#34;user1&#34;</span><span class=p>,</span> <span class=nx>Score</span><span class=p>:</span> <span class=mi>10</span><span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span><span class=nx>Member</span><span class=p>:</span> <span class=s>&#34;user2&#34;</span><span class=p>,</span> <span class=nx>Score</span><span class=p>:</span> <span class=mi>232</span><span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span><span class=nx>Member</span><span class=p>:</span> <span class=s>&#34;user3&#34;</span><span class=p>,</span> <span class=nx>Score</span><span class=p>:</span> <span class=mi>129</span><span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span><span class=nx>Member</span><span class=p>:</span> <span class=s>&#34;user4&#34;</span><span class=p>,</span> <span class=nx>Score</span><span class=p>:</span> <span class=mi>232</span><span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 清空榜单
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>Del</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>ex06RankKey</span><span class=p>).</span><span class=nf>Err</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>nums</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>ZAdd</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>ex06RankKey</span><span class=p>,</span> <span class=nx>initList</span><span class=o>...</span><span class=p>).</span><span class=nf>Result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;初始化榜单Item数量：%d\n&#34;</span><span class=p>,</span> <span class=nx>nums</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 获取全部榜单
</span></span></span><span class=line><span class=cl><span class=c1>// 榜单逆序输出
</span></span></span><span class=line><span class=cl><span class=c1>// ZRANGE ex06_rank_zset +inf -inf BYSCORE  rev WITHSCORES
</span></span></span><span class=line><span class=cl><span class=c1>// 正序输出
</span></span></span><span class=line><span class=cl><span class=c1>// ZRANGE ex06_rank_zset 0 -1 WITHSCORES
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>ex06GetOrderListAll</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>resList</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>ZRevRangeWithScores</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>ex06RankKey</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>).</span><span class=nf>Result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;\n榜单：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>z</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>resList</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;第%d名，name=%s, score=%.2f\n&#34;</span><span class=p>,</span> <span class=nx>i</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span> <span class=nx>z</span><span class=p>.</span><span class=nx>Member</span><span class=p>,</span> <span class=nx>z</span><span class=p>.</span><span class=nx>Score</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 分页获取榜单
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>ex06GetOrderListByPage</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>page</span><span class=p>,</span> <span class=nx>pageSize</span> <span class=kt>int64</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// zrange ex06_rank_zset 300 0 byscore rev limit 1 2 withscores // 取300分到0分之间的排名
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// zrange ex06_rank_zset -inf +inf byscore withscores 正序输出
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// zrange ex06_rank_zset +inf -inf byscore rev WITHSCORES 逆序输出所有排名
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// zrange ex06_rank_zset +inf -inf byscore rev limit 0 2 withscores 逆序分页输出排名
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>offset</span> <span class=o>:=</span> <span class=nb>int</span><span class=p>((</span><span class=nx>page</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=nx>pageSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>zRangeArgs</span> <span class=o>:=</span> <span class=nx>redis</span><span class=p>.</span><span class=nx>ZRangeArgs</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Key</span><span class=p>:</span>     <span class=nx>ex06RankKey</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ByScore</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Rev</span><span class=p>:</span>     <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Start</span><span class=p>:</span>   <span class=s>&#34;-inf&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Stop</span><span class=p>:</span>    <span class=s>&#34;+inf&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Offset</span><span class=p>:</span>  <span class=nb>int64</span><span class=p>(</span><span class=nx>offset</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>Count</span><span class=p>:</span>   <span class=nx>pageSize</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>resList</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>ZRangeArgsWithScores</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>zRangeArgs</span><span class=p>).</span><span class=nf>Result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;榜单(page=%d, pageSize=%d)\n&#34;</span><span class=p>,</span> <span class=nx>page</span><span class=p>,</span> <span class=nx>pageSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>z</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>resList</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rank</span> <span class=o>:=</span> <span class=nx>i</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>+</span> <span class=nx>offset</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;第%d名 %s\t%.2f\n&#34;</span><span class=p>,</span> <span class=nx>rank</span><span class=p>,</span> <span class=nx>z</span><span class=p>.</span><span class=nx>Member</span><span class=p>,</span> <span class=nx>z</span><span class=p>.</span><span class=nx>Score</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 获取用户排名
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>ex06GetUserRankByName</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>name</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>rank</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>ZRevRank</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>ex06RankKey</span><span class=p>,</span> <span class=nx>name</span><span class=p>).</span><span class=nf>Result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;name=%s, rank=%d\n&#34;</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>rank</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 获取用户分数信息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>ex06GetUserScoreByName</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>name</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>score</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>ZScore</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>ex06RankKey</span><span class=p>,</span> <span class=nx>name</span><span class=p>).</span><span class=nf>Result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;name=%s, score=%.2f\n&#34;</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>score</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ex06AddUserScore 增加用户分数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>ex06AddUserScore</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>name</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>score</span> <span class=kt>float64</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>num</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>ZIncrBy</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>ex06RankKey</span><span class=p>,</span> <span class=nx>score</span><span class=p>,</span> <span class=nx>name</span><span class=p>).</span><span class=nf>Result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;name=%s, add_score=%.2f, score=%.2f\n&#34;</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>score</span><span class=p>,</span> <span class=nx>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=测试功能-1>测试功能</h3><p>测试脚本：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>go run main.go Ex06 init <span class=c1># 初始化积分</span>
</span></span><span class=line><span class=cl>go run main.go Ex06 rev_order <span class=c1># 输出完整榜单</span>
</span></span><span class=line><span class=cl>go run main.go Ex06 order_page <span class=m>1</span> <span class=c1># 逆序分页输出，page=1</span>
</span></span><span class=line><span class=cl>go run main.go Ex06 order_page <span class=m>2</span> <span class=c1># 逆序分页输出，page=2</span>
</span></span><span class=line><span class=cl>go run main.go Ex06 get_rank user2 <span class=c1># 获取user2的排名</span>
</span></span><span class=line><span class=cl>go run main.go Ex06 get_score user2 <span class=c1># 获取user2的分数</span>
</span></span><span class=line><span class=cl>go run main.go Ex06 add_user_score user2 <span class=m>10</span> <span class=c1># 为user2增加10分</span>
</span></span><span class=line><span class=cl>go run main.go Ex06 get_rank user2 <span class=c1># 获取user2的排名</span>
</span></span><span class=line><span class=cl>go run main.go Ex06 get_score user2 <span class=c1># 获取user2的分数</span>
</span></span></code></pre></td></tr></table></div></div><p>执行结果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex06
</span></span><span class=line><span class=cl>init
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl>初始化榜单Item数量：4
</span></span><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex06
</span></span><span class=line><span class=cl>rev_order
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>榜单：
</span></span><span class=line><span class=cl>第1名，name<span class=o>=</span>user4, <span class=nv>score</span><span class=o>=</span>232.00
</span></span><span class=line><span class=cl>第2名，name<span class=o>=</span>user2, <span class=nv>score</span><span class=o>=</span>232.00
</span></span><span class=line><span class=cl>第3名，name<span class=o>=</span>user3, <span class=nv>score</span><span class=o>=</span>129.00
</span></span><span class=line><span class=cl>第4名，name<span class=o>=</span>user1, <span class=nv>score</span><span class=o>=</span>10.00
</span></span><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex06
</span></span><span class=line><span class=cl>order_page
</span></span><span class=line><span class=cl><span class=m>1</span>
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl>榜单<span class=o>(</span><span class=nv>page</span><span class=o>=</span>1, <span class=nv>pageSize</span><span class=o>=</span>2<span class=o>)</span>
</span></span><span class=line><span class=cl>第1名 user4	232.00
</span></span><span class=line><span class=cl>第2名 user2	232.00
</span></span><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex06
</span></span><span class=line><span class=cl>order_page
</span></span><span class=line><span class=cl><span class=m>2</span>
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl>榜单<span class=o>(</span><span class=nv>page</span><span class=o>=</span>2, <span class=nv>pageSize</span><span class=o>=</span>2<span class=o>)</span>
</span></span><span class=line><span class=cl>第3名 user3	129.00
</span></span><span class=line><span class=cl>第4名 user1	10.00
</span></span><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex06
</span></span><span class=line><span class=cl>get_rank
</span></span><span class=line><span class=cl>user2
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl><span class=nv>name</span><span class=o>=</span>user2, <span class=nv>rank</span><span class=o>=</span><span class=m>2</span>
</span></span><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex06
</span></span><span class=line><span class=cl>get_score
</span></span><span class=line><span class=cl>user2
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl><span class=nv>name</span><span class=o>=</span>user2, <span class=nv>score</span><span class=o>=</span>232.00
</span></span><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex06
</span></span><span class=line><span class=cl>add_user_score
</span></span><span class=line><span class=cl>user2
</span></span><span class=line><span class=cl><span class=m>10</span>
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl><span class=nv>name</span><span class=o>=</span>user2, <span class=nv>add_score</span><span class=o>=</span>10.00, <span class=nv>score</span><span class=o>=</span>242.00
</span></span><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex06
</span></span><span class=line><span class=cl>get_rank
</span></span><span class=line><span class=cl>user2
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl><span class=nv>name</span><span class=o>=</span>user2, <span class=nv>rank</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex06
</span></span><span class=line><span class=cl>get_score
</span></span><span class=line><span class=cl>user2
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl><span class=nv>name</span><span class=o>=</span>user2, <span class=nv>score</span><span class=o>=</span>242.00
</span></span></code></pre></td></tr></table></div></div><h2 id=07-基于pubsub的消息订阅>07-基于<code>PubSub</code>的消息订阅</h2><p>对于文章的发布与订阅，也可以使用 PubSub 实现</p><h3 id=代码实现-6>代码实现</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>example</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;strconv&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=nx>ex07Channel</span> <span class=p>=</span> <span class=s>&#34;es_ch&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Ex07</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>pubSub</span> <span class=o>:=</span> <span class=nx>RedisCli</span><span class=p>.</span><span class=nf>Subscribe</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>ex07Channel</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=mi>5</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>RedisCli</span><span class=p>.</span><span class=nf>Publish</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>ex07Channel</span><span class=p>,</span> <span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>pubSub</span><span class=p>.</span><span class=nf>Unsubscribe</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>ex07Channel</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>_</span> <span class=p>=</span> <span class=nx>pubSub</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>msg</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>pubSub</span><span class=p>.</span><span class=nf>Channel</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>arcId</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseInt</span><span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=nx>Payload</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;读取文章[%d]标题、正文，发送到ES更新索引\n&#34;</span><span class=p>,</span> <span class=nx>arcId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=测试结果go-run-maingo-ex07>测试结果：<code>go run main.go Ex07</code></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>base<span class=o>)</span> ➜  go-redis-example git:<span class=o>(</span>main<span class=o>)</span> ✗ go run main.go Ex07
</span></span><span class=line><span class=cl>输入参数:
</span></span><span class=line><span class=cl>Ex07
</span></span><span class=line><span class=cl>----------
</span></span><span class=line><span class=cl>读取文章<span class=o>[</span>0<span class=o>]</span>标题、正文，发送到ES更新索引
</span></span><span class=line><span class=cl>读取文章<span class=o>[</span>1<span class=o>]</span>标题、正文，发送到ES更新索引
</span></span><span class=line><span class=cl>读取文章<span class=o>[</span>2<span class=o>]</span>标题、正文，发送到ES更新索引
</span></span><span class=line><span class=cl>读取文章<span class=o>[</span>3<span class=o>]</span>标题、正文，发送到ES更新索引
</span></span><span class=line><span class=cl>读取文章<span class=o>[</span>4<span class=o>]</span>标题、正文，发送到ES更新索引
</span></span></code></pre></td></tr></table></div></div><h2 id=总结>总结</h2><p>通过上述的 Redis 实战案例，管中窥豹地了解了 Redis 的一些经典用法。实际上 Redis 的功能并不止于此，在日后的学习工作中，Redis 也将会继续发挥更大的作用。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2025-01-26&nbsp;<a class=git-hash href=https://github.com/pjimming/blog/commit/de5fce5616fea8d08ae0462fbeaef539917874fe target=_blank title="commit by panjiangming(panjiangming@kuaishou.com) de5fce5616fea8d08ae0462fbeaef539917874fe: replace cdn: jsdelivr -> cloudfare">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>de5fce5</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/2024-03-26/example-golang/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://blog.pjmcode.top/2024-03-26/example-golang/ data-title=『实战』使用Golang实现Redis经典应用案例 data-hashtags=redis,golang,实战><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://blog.pjmcode.top/2024-03-26/example-golang/ data-hashtag=redis><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://blog.pjmcode.top/2024-03-26/example-golang/ data-title=『实战』使用Golang实现Redis经典应用案例><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://blog.pjmcode.top/2024-03-26/example-golang/ data-title=『实战』使用Golang实现Redis经典应用案例><i data-svg-src=/lib/simple-icons/icons/line.min.svg aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://blog.pjmcode.top/2024-03-26/example-golang/ data-title=『实战』使用Golang实现Redis经典应用案例 data-image=https://picx-img.pjmcode.top/20240326/image-image.969ibnzd46.webp><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/redis/>Redis</a>,&nbsp;<a href=/tags/golang/>Golang</a>,&nbsp;<a href=/tags/%E5%AE%9E%E6%88%98/>实战</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/2024-03-24/pprof-theory/ class=prev rel=prev title=Golang性能分析工具之pprof采样过程与原理><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Golang性能分析工具之pprof采样过程与原理</a>
<a href=/2024-04-01/qiniu/ class=next rel=next title=【纪念向】我在杭州七牛云的323天>【纪念向】我在杭州七牛云的323天<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app>Giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><span id=run-time></span></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2024 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=备案编号" target=_blank>浙ICP备2024074882号</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.js></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:-1},comment:{giscus:{category:"Announcements",categoryId:"DIC_kwDOLZmgDc4Cdm7x",darkTheme:"preferred_color_scheme",emitMetadata:"0",inputPosition:"top",lang:"zh-CN",lazyLoading:!1,lightTheme:"light",mapping:"pathname",reactionsEnabled:"1",repo:"pjimming/blog-comment",repoId:"R_kgDOLZmgDQ"}},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript src=https://cdn.staticfile.net/jquery/2.2.4/jquery.min.js></script><script type=text/javascript src=/js/custom.js></script></body></html>