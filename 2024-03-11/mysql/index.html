<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>面试题精选--MySQL篇 - 江明说|Jimmy Talk</title><meta http-equiv=x-dns-prefetch-control content="on">
<link rel=dns-prefetch href=//cdn.jsdelivr.net><link rel=dns-prefetch href=//pjimming.github.io><meta name=Description content="江明说"><meta property="og:url" content="https://blog.pjmcode.top/2024-03-11/mysql/"><meta property="og:site_name" content="江明说|Jimmy Talk"><meta property="og:title" content="面试题精选--MySQL篇"><meta property="og:description" content="总结一些常考的 MySQL 面试题，相关资料皆从网络上收集"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-11T15:27:10+08:00"><meta property="article:modified_time" content="2024-07-07T10:07:16+08:00"><meta property="article:tag" content="Interview"><meta property="article:tag" content="Mysql"><meta property="og:image" content="https://blog.pjmcode.top/logo.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.pjmcode.top/logo.png"><meta name=twitter:title content="面试题精选--MySQL篇"><meta name=twitter:description content="总结一些常考的 MySQL 面试题，相关资料皆从网络上收集"><meta name=application-name content="江明说"><meta name=apple-mobile-web-app-title content="江明说"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=/images/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.pjmcode.top/2024-03-11/mysql/><link rel=prev href=https://blog.pjmcode.top/2024-03-11/golang/><link rel=next href=https://blog.pjmcode.top/2024-03-12/20240312/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"面试题精选--MySQL篇","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.pjmcode.top\/2024-03-11\/mysql\/"},"genre":"posts","keywords":"interview, mysql","wordcount":6542,"url":"https:\/\/blog.pjmcode.top\/2024-03-11\/mysql\/","datePublished":"2024-03-11T15:27:10+08:00","dateModified":"2024-07-07T10:07:16+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"PanJM"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="江明说|Jimmy Talk"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/favicon.ico data-srcset="/images/favicon.ico, /images/favicon.ico 1.5x, /images/favicon.ico 2x" data-sizes=auto alt=/images/favicon.ico title=/images/favicon.ico>Jimmy Talk</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class='fa-solid fa-box-archive'></i> 所有文章 </a><a class=menu-item href=/tags/><i class='fa-solid fa-tag'></i> 标签 </a><a class=menu-item href=/categories/><i class='fa-solid fa-table-list'></i> 分类 </a><a class=menu-item href=/friend/><i class='fa-solid fa-user-group'></i> 友链 </a><a class=menu-item href=/book-list/><i class='fa-solid fa-book'></i> 书单 </a><a class=menu-item href=/about/><i class='fa-regular fa-address-card'></i> 关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="江明说|Jimmy Talk"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/favicon.ico data-srcset="/images/favicon.ico, /images/favicon.ico 1.5x, /images/favicon.ico 2x" data-sizes=auto alt=/images/favicon.ico title=/images/favicon.ico>Jimmy Talk</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title><i class='fa-solid fa-box-archive'></i>所有文章</a><a class=menu-item href=/tags/ title><i class='fa-solid fa-tag'></i>标签</a><a class=menu-item href=/categories/ title><i class='fa-solid fa-table-list'></i>分类</a><a class=menu-item href=/friend/ title><i class='fa-solid fa-user-group'></i>友链</a><a class=menu-item href=/book-list/ title><i class='fa-solid fa-book'></i>书单</a><a class=menu-item href=/about/ title><i class='fa-regular fa-address-card'></i>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">面试题精选--MySQL篇</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/pjimming/ title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>PanJM</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/interview/><i class="far fa-folder fa-fw" aria-hidden=true></i>Interview</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2024-03-11>2024-03-11</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 6542 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 14 分钟&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.4qr2l18ab2.webp data-srcset="https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.4qr2l18ab2.webp, https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.4qr2l18ab2.webp 1.5x, https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.4qr2l18ab2.webp 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.4qr2l18ab2.webp title=https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.4qr2l18ab2.webp></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#事物>事物</a><ul><li><a href=#事物的四大特性>事物的四大特性</a></li><li><a href=#事物的隔离级别>事物的隔离级别</a></li><li><a href=#什么是脏读不可重复读和幻读>什么是脏读、不可重复读和幻读</a><ul><li><a href=#脏读>脏读</a></li><li><a href=#不可重复读>不可重复读</a></li><li><a href=#幻读>幻读</a></li></ul></li><li><a href=#默认隔离级别-rr>默认隔离级别-RR</a></li><li><a href=#rr-和-rc-使用场景>RR 和 RC 使用场景</a></li><li><a href=#行锁表锁意向锁>行锁，表锁，意向锁</a><ul><li><a href=#表级锁串行化>表级锁：（串行化）</a></li><li><a href=#行级锁rrrc>行级锁：（RR、RC）</a></li></ul></li><li><a href=#mvcc-多版本并发控制>MVCC 多版本并发控制</a><ul><li><a href=#read-view>Read View：</a></li><li><a href=#trx_id>trx_id：</a></li></ul></li></ul></li><li><a href=#索引>索引</a><ul><li><a href=#innodb-和-myisam-引擎>Innodb 和 Myisam 引擎</a></li><li><a href=#哈希索引>哈希索引</a></li><li><a href=#b树索引>B+树索引</a></li><li><a href=#创建索引>创建索引</a></li><li><a href=#聚簇索引和非聚簇索引>聚簇索引和非聚簇索引</a></li><li><a href=#最左前缀问题>最左前缀问题</a></li></ul></li><li><a href=#sql-查询>SQL 查询</a><ul><li><a href=#sql-语句执行过程>SQL 语句执行过程</a></li><li><a href=#回表查询和覆盖索引>回表查询和覆盖索引</a></li><li><a href=#explain-及优化>Explain 及优化</a><ul><li><a href=#索引优化>索引优化：</a></li><li><a href=#语句优化>语句优化：</a></li><li><a href=#表结构优化>表结构优化：</a></li><li><a href=#数据库范式->数据库范式 ：</a></li><li><a href=#配置优化>配置优化：</a></li></ul></li><li><a href=#join-查询>JOIN 查询</a></li></ul></li><li><a href=#集群>集群</a><ul><li><a href=#主从复制过程>主从复制过程</a><ul><li><a href=#mysql-主从复制>MySQl 主从复制：</a></li><li><a href=#binlog-记录格式statementrowmixed>binlog 记录格式：statement、row、mixed</a></li></ul></li><li><a href=#数据一致性问题>数据一致性问题</a><ul><li><a href=#缓存记录写-key-法>缓存记录写 key 法：</a></li><li><a href=#异步复制>异步复制：</a></li><li><a href=#半同步复制>半同步复制：</a></li><li><a href=#全同步复制>全同步复制：</a></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fwnote"></i>注意<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><span>这篇文章最后修改于</span>
<span class=timeago datetime=2024-07-07T10:07:16 title="July 7, 2024">July 7, 2024</span>
<span>，请鉴别其时效性，以免造成不必要的麻烦。</span></div></div></div><p>总结一些常考的 MySQL 面试题，相关资料皆从网络上收集</p><hr><h2 id=事物>事物</h2><h3 id=事物的四大特性>事物的四大特性</h3><p>事物的四大特性：原子性、一致性、隔离性、持久性，简称 ACID</p><ul><li>原子性：事物是最小的执行单位，不允许分割。要么全都执行，要么全都不执行</li><li>一致性：执⾏事务前后，数据保持⼀致，多个事务对同⼀个数据读取的结果是相同的</li><li>隔离性：并发访问数据库时，一个用户的事物不被其他事物所干扰，各并发事物之间数据库是独立的</li><li>持久性：一个事物被提交后，对于数据库的改变是持久的，即使数据库发生故障也不应该对其有任何影响</li></ul><p>实现保证：MySQL 的存储引擎 InnoDB 使用重做日志保证一致性与持久性，回滚日志保证原子性，使用各种锁来保证隔离性。</p><h3 id=事物的隔离级别>事物的隔离级别</h3><ul><li>读未提交：最低的隔离级别，允许读取尚未提交的数据变更，可能会导致脏读、幻读或不可重复读。</li><li>读已提交：允许读取并发事务已经提交的数据，可以阻⽌脏读，但是幻读或不可重复读仍有可能发⽣。</li><li>可重复读：同⼀字段的多次读取结果都是⼀致的，除⾮数据是被本身事务⾃⼰所修改，可以阻⽌脏读和不可重复读，会有幻读。</li><li>串行化：最⾼的隔离级别，完全服从 ACID 的隔离级别。所有的事务依次逐个执⾏，这样事务之间就完全不可能产⽣⼲扰。</li></ul><table><thead><tr><th style=text-align:center>隔离级别</th><th style=text-align:center>并发问题</th></tr></thead><tbody><tr><td style=text-align:center>读未提交</td><td style=text-align:center>可能导致脏读、幻读或不可重复读</td></tr><tr><td style=text-align:center>读已提交</td><td style=text-align:center>可能导致幻读或不可重复读</td></tr><tr><td style=text-align:center>可重复读</td><td style=text-align:center>可能导致幻读</td></tr><tr><td style=text-align:center>串行化</td><td style=text-align:center>不会产生干扰</td></tr></tbody></table><h3 id=什么是脏读不可重复读和幻读>什么是脏读、不可重复读和幻读</h3><h4 id=脏读>脏读</h4><p>脏读（Dirty Read）是指一个事务读取了另一个未提交的事务所写入的数据。</p><p>假设有两个事务 T1 和 T2，T1 在读取某个数据之后，T2 修改了该数据但尚未提交，如果 T1 再次读取该数据，就会读取到 T2 修改后的“脏数据”，因为 T2 的修改最终可能被回滚，导致读取到的数据不正确。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.3nrda66ljv.webp data-srcset="https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.3nrda66ljv.webp, https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.3nrda66ljv.webp 1.5x, https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.3nrda66ljv.webp 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.3nrda66ljv.webp title=image.3nrda66ljv.webp></p><h4 id=不可重复读>不可重复读</h4><p>不可重复读（Non-repeatable Read）是指一个事务在相同的查询条件下多次读取同一行数据时，得到的结果不一致。</p><p>假设事务 T1 执行了一次查询并读取了某行数据，然后事务 T2 修改了该行数据并提交，如果 T1 再次执行相同的查询，得到的结果就可能与之前不同。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.5c0q7d95ts.webp data-srcset="https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.5c0q7d95ts.webp, https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.5c0q7d95ts.webp 1.5x, https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.5c0q7d95ts.webp 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.5c0q7d95ts.webp title=image.5c0q7d95ts.webp></p><h4 id=幻读>幻读</h4><p>幻读（Phantom Read）是指一个事务在相同的查询条件下多次执行查询，得到的结果集不一致。</p><p>假设事务 T1 执行了一次查询并返回了一些行数据，然后事务 T2 在这些行数据中插入了新的数据并提交，如果 T1 再次执行相同的查询，得到的结果集就可能与之前不同。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.99t3o1koao.webp data-srcset="https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.99t3o1koao.webp, https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.99t3o1koao.webp 1.5x, https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.99t3o1koao.webp 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.99t3o1koao.webp title=image.99t3o1koao.webp></p><h3 id=默认隔离级别-rr>默认隔离级别-RR</h3><p>MySQL 默认的隔离级别为可重复读，即：同⼀字段的多次读取结果都是⼀致的，除⾮数据是被本身事务⾃⼰所修改；</p><p>可重复读是有可能出现幻读的，如果要保证绝对的安全只能把隔离级别设置成 <code>SERIALIZABLE</code>；这样所有事务都只能顺序执行，自然不会因为并发有什么影响了，但是性能会下降许多。</p><p>第二种方式，针对快照读（普通 <code>select</code> 语句），是通过 MVCC 方式解决了幻读，因为可重复读隔离级别下，事务执行过程中看到的数据，一直跟这个事务启动时看到的数据是一致的，即使中途有其他事务插入了一条数据，是查询不出来这条数据的，所以就很好了避免幻读问题。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=n>id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=n>table_xx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>and</span><span class=w> </span><span class=k>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Vupdate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=n>id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=n>table_xx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>and</span><span class=w> </span><span class=k>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>第三种方式，针对当前读（<code>select ... for update</code> 等语句），是通过 <code>next-key lock</code>（记录锁+间隙锁）方式解决了幻读，因为当执行 <code>select ... for update</code> 语句的时候，会加上 <code>next-key lock</code>，如果有其他事务在 <code>next-key lock</code> 锁范围内插入了一条记录，那么这个插入语句就会被阻塞，无法成功插入，所以就很好了避免幻读问题。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=n>id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=n>table_xx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=k>for</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>update</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=n>id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=n>table_xx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>share</span><span class=w> </span><span class=k>mode</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=rr-和-rc-使用场景>RR 和 RC 使用场景</h3><p>事务隔离级别 RC(read commit)和 RR（repeatable read）两种事务隔离级别基于多版本并发控制 MVCC(multi-version concurrency control）来实现。</p><p>「读提交」隔离级别是在每个 <code>select</code> 都会生成一个新的 Read View，也意味着，事务期间的多次读取同一条数据，前后两次读的数据可能会出现不一致，因为可能这期间另外一个事务修改了该记录，并提交了事务。</p><p>「可重复读」隔离级别是启动事务时生成一个 Read View，然后整个事务期间都在用这个 Read View，这样就保证了在事务期间读到的数据都是事务启动前的记录。</p><table><thead><tr><th></th><th>RC</th><th>RR</th></tr></thead><tbody><tr><td>实现</td><td>多个 <code>select</code> 会创建多个不同的 Read View</td><td>仅需要一个版本的 Read View</td></tr><tr><td>粒度</td><td>语句级读一致性</td><td>事物级读一致性</td></tr><tr><td>准确性</td><td>每次语句执行时间点的数据</td><td>第一条语句执行时间点的数据</td></tr></tbody></table><h3 id=行锁表锁意向锁>行锁，表锁，意向锁</h3><p>InnoDB ⽀持⾏级锁(row-level locking)和表级锁，默认为⾏级锁</p><p>InnoDB 按照不同的分类的锁：</p><ul><li>共享/排它锁(Shared and Exclusive Locks)：行级别锁，</li><li>意向锁(Intention Locks)，表级别锁</li><li>间隙锁(Gap Locks)，锁定一个区间</li><li>记录锁(Record Locks)，锁定一个行记录</li></ul><h4 id=表级锁串行化>表级锁：（串行化）</h4><p>Mysql 中锁定<strong>粒度最大</strong>的一种锁，对当前操作的整张表加锁，实现简单，资源消耗也比较少，加锁快，不会出现死锁。其锁定粒度最大，触发锁冲突的概率最高，并发度最低，MyISAM 和 InnoDB 引擎都支持表级锁。</p><h4 id=行级锁rrrc>行级锁：（RR、RC）</h4><p>Mysql 中锁定<strong>粒度最小</strong>的一种锁，只针对当前操作的行进行加锁。行级锁能大大减少数据库操作的冲突。其加锁粒度最小，并发度高，但加锁的开销也最大，加锁慢，会出现死锁。InnoDB 支持的行级锁，包括如下几种：</p><ul><li><p>记录锁（Record Lock）: 对索引项加锁，锁定符合条件的行。其他事务不能修改和删除加锁项；</p></li><li><p>间隙锁（Gap Lock）: 对索引项之间的“间隙”加锁，锁定记录的范围，不包含索引项本身，其他事务不能在锁范围内插入数据。</p></li><li><p>Next-key Lock： 锁定索引项本身和索引范围。即 Record Lock 和 Gap Lock 的结合。可解决幻读问题。</p><p>InnoDB 支持多粒度锁（multiple granularity locking），它允许行级锁与表级锁共存，而意向锁就是其中的一种表锁。</p></li><li><p>共享锁（ shared lock, S ）锁允许持有锁读取行的事务。加锁时将自己和子节点全加 S 锁，父节点直到表头全加 IS 锁</p></li><li><p>排他锁（ exclusive lock， X ）锁允许持有锁修改行的事务。 加锁时将自己和子节点全加 X 锁，父节点直到表头全加 IX 锁</p></li><li><p>意向共享锁（intention shared lock, IS）：事务有意向对表中的某些行加共享锁（S 锁）</p></li><li><p>意向排他锁（intention exclusive lock, IX）：事务有意向对表中的某些行加排他锁（X 锁）</p></li></ul><table><thead><tr><th style=text-align:center>互斥性</th><th style=text-align:center>共享锁（S）</th><th style=text-align:center>排他锁（X）</th><th style=text-align:center>意向共享锁（IS）</th><th style=text-align:center>意向排他锁（IX）</th></tr></thead><tbody><tr><td style=text-align:center>共享锁</td><td style=text-align:center>✅</td><td style=text-align:center>❌</td><td style=text-align:center>✅</td><td style=text-align:center>❌</td></tr><tr><td style=text-align:center>排他锁</td><td style=text-align:center>❌</td><td style=text-align:center>❌</td><td style=text-align:center>❌</td><td style=text-align:center>❌</td></tr><tr><td style=text-align:center>意向共享锁</td><td style=text-align:center>✅</td><td style=text-align:center>❌</td><td style=text-align:center>✅</td><td style=text-align:center>✅</td></tr><tr><td style=text-align:center>意向排他锁</td><td style=text-align:center>❌</td><td style=text-align:center>❌</td><td style=text-align:center>✅</td><td style=text-align:center>✅</td></tr></tbody></table><h3 id=mvcc-多版本并发控制>MVCC 多版本并发控制</h3><p>MVCC 是一种多版本并发控制机制，通过事务的可见性看到自己预期的数据，能降低其系统开销。（RC 和 RR 级别工作）</p><p>InnoDB 的 MVCC,是通过在每行记录后面保存系统版本号(可以理解为事务的 ID)，每开始一个新的事务，系统版本号就会自动递增，事务开始时刻的系统版本号会作为事务的 ID。这样可以确保事务读取的行，要么是在事务开始前已经存在的，要么是事务自身插入或者修改过的，防止幻读的产生。</p><ol><li>MVCC 手段只适用于 Msyql 隔离级别中的读已提交（Read committed）和可重复读（Repeatable Read）.</li><li>Read uncimmitted 由于存在脏读，即能读到未提交事务的数据行，所以不适用 MVCC.</li><li>简单的 select 快照度不会加锁，删改及 <code>select for update</code> 等需要当前读的场景会加锁</li></ol><p>原因是 MVCC 的创建版本和删除版本只要在事务提交后才会产生。客观上，mysql 使用的是乐观锁的一整实现方式，就是每行都有版本号，保存时根据版本号决定是否成功。Innodb 的 MVCC 使用到的快照存储在 Undo 日志中，该日志通过回滚指针把一个数据行所有快照连接起来。</p><p>在 InnoDB 引擎表中，它的聚簇索引记录中有两个必要的隐藏列：</p><ul><li>trx_id：这个 id 用来存储的每次对某条聚簇索引记录进行修改的时候的事务 id。</li><li>roll_pointer：每次对哪条聚簇索引记录有修改的时候，都会把老版本写入 undo 日志中。这个 roll_pointer 就是存了一个指针，它指向这条聚簇索引记录的上一个版本的位置，通过它来获得上一个版本的记录信息。(注意插入操作的 undo 日志没有这个属性，因为它没有老版本)</li></ul><h4 id=read-view>Read View：</h4><p><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.5c0q7f8meb.webp data-srcset="https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.5c0q7f8meb.webp, https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.5c0q7f8meb.webp 1.5x, https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.5c0q7f8meb.webp 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.5c0q7f8meb.webp title=image.5c0q7f8meb.webp></p><p>Read View 有四个重要的字段：</p><ul><li><code>m_ids</code> ：指的是在创建 Read View 时，当前数据库中「活跃事务」的事务 id 列表，注意是一个列表，“活跃事务”指的就是，启动了但还没提交的事务。</li><li><code>min_trx_id</code> ：指的是在创建 Read View 时，当前数据库中「活跃事务」中事务 id 最小的事务，也就是 m_ids 的最小值。</li><li><code>max_trx_id</code> ：这个并不是 m_ids 的最大值，而是创建 Read View 时当前数据库中应该给下一个事务的 id 值，也就是全局事务中最大的事务 id 值 + 1；</li><li><code>creator_trx_id</code> ：指的是创建该 Read View 的事务的事务 id。</li></ul><p>每次修改都会在版本链中记录。SELECT 可以去版本链中拿记录，这就实现了读-写，写-读的并发执行，提升了系统的性能。</p><h4 id=trx_id>trx_id：</h4><p><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.7p3commubs.webp data-srcset="https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.7p3commubs.webp, https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.7p3commubs.webp 1.5x, https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.7p3commubs.webp 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.7p3commubs.webp title=image.7p3commubs.webp></p><p>一个事务去访问记录的时候，除了自己的更新记录总是可见之外，还有这几种情况：</p><ul><li>如果记录的 trx_id 值小于 Read View 中的 min_trx_id 值，表示这个版本的记录是在创建 Read View 前已经提交的事务生成的，所以该版本的记录对当前事务可见。</li><li>如果记录的 trx_id 值大于等于 Read View 中的 max_trx_id 值，表示这个版本的记录是在创建 Read View 后才启动的事务生成的，所以该版本的记录对当前事务不可见。</li><li>如果记录的 trx_id 值在 Read View 的 min_trx_id 和 max_trx_id 之间，需要判断 trx_id 是否在 m_ids 列表中：<ul><li>如果记录的 trx_id 在 m_ids 列表中，表示生成该版本记录的活跃事务依然活跃着（还没提交事务），所以该版本的记录对当前事务不可见。</li><li>如果记录的 trx_id 不在 m_ids 列表中，表示生成该版本记录的活跃事务已经被提交，所以该版本的记录对当前事务可见。</li></ul></li></ul><h2 id=索引>索引</h2><h3 id=innodb-和-myisam-引擎>Innodb 和 Myisam 引擎</h3><p><strong>Myisam</strong>：支持表锁，适合读密集的场景，不支持外键，不支持事务，索引与数据在不同的文件</p><p><strong>Innodb</strong>：支持行、表锁，默认为行锁，适合并发场景，支持外键，支持事务，索引与数据同一文件</p><h3 id=哈希索引>哈希索引</h3><p>哈希索引用索引列的值计算该值的 hashCode，然后在 hashCode 相应的位置存执该值所在行数据的物理位置，因为使用散列算法，因此访问速度非常快，但是一个值只能对应一个 hashCode，而且是散列的分布方式，因此哈希索引不支持范围查找和排序的功能。</p><h3 id=b树索引>B+树索引</h3><p>优点：</p><p>B+树的磁盘读写代价低，更少的查询次数，查询效率更加稳定，有利于对数据库的扫描</p><p>B+树是 B 树的升级版，B+树只有叶节点存放数据，其余节点用来索引。索引节点可以全部加入内存，增加查询效率，叶子节点可以做双向链表，从而提高范围查找的效率，增加的索引的范围。</p><p>在大规模数据存储的时候，红黑树往往出现由于树的深度过大而造成磁盘 I/O 读写过于频繁，进而导致效率低下的情况。所以，只要我们通过某种较好的树结构减少树的结构尽量减少树的高度，B 树与 B+树可以有多个子女，从几十到上千，可以降低树的高度。</p><p>磁盘预读原理：将一个节点的大小设为等于一个页，这样每个节点只需要一次 I/O 就可以完全载入。为了达到这个目的，在实际实现 B-Tree 还需要使用如下技巧：每次新建节点时，直接申请一个页的空间，这样就保证一个节点物理上也存储在一个页里，加之计算机存储分配都是按页对齐的，就实现了一个 node 只需一次 I/O。</p><h3 id=创建索引>创建索引</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=p>[</span><span class=k>UNIQUE</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>FULLTEXT</span><span class=p>]</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=err>索引名</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=err>表名</span><span class=p>(</span><span class=err>字段名</span><span class=p>)</span><span class=w> </span><span class=p>[</span><span class=k>USING</span><span class=w> </span><span class=err>索引方法</span><span class=p>];</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>说明：</p><ul><li>UNIQUE：可选。表示索引为唯一性索引。</li><li>FULLTEXT：可选。表示索引为全文索引。</li><li>INDEX 和 KEY：用于指定字段为索引，两者选择其中之一就可以了，作用是一样的。</li><li>索引名：可选。给创建的索引取一个新名称。</li><li>字段名：指定索引对应的字段的名称，该字段必须是前面定义好的字段。</li><li>索引方法：默认使用 B+TREE。</li></ul><h3 id=聚簇索引和非聚簇索引>聚簇索引和非聚簇索引</h3><p>聚簇索引：将数据存储与索引放到了一块，索引结构的叶子节点保存了行数据（主键索引）</p><p>非聚簇索引：将数据与索引分开存储，索引结构的叶子节点指向了数据对应的位置（辅助索引）</p><p>聚簇索引的叶子节点就是数据节点，而非聚簇索引的叶子节点仍然是索引节点，只不过有指向对应数据块的指针。</p><h3 id=最左前缀问题>最左前缀问题</h3><p>最左前缀原则主要使用在联合索引中，联合索引的 B+Tree 是按照第一个关键字进行索引排列的。</p><p>联合索引的底层是一颗 B+树，只不过联合索引的 B+树节点中存储的是键值。由于构建一棵 B+树只能根据一个值来确定索引关系，所以数据库依赖联合索引最左的字段来构建。</p><p>采用>、&lt;等进行匹配都会导致后面的列无法走索引，因为通过以上方式匹配到的数据是不可知的。</p><h2 id=sql-查询>SQL 查询</h2><h3 id=sql-语句执行过程>SQL 语句执行过程</h3><p>查询语句：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w>  </span><span class=n>A</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>A</span><span class=p>.</span><span class=n>age</span><span class=o>=</span><span class=s1>&#39;18&#39;</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>A</span><span class=p>.</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;张三&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.2a4u67odm9.webp data-srcset="https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.2a4u67odm9.webp, https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.2a4u67odm9.webp 1.5x, https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.2a4u67odm9.webp 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.2a4u67odm9.webp title=image.2a4u67odm9.webp></p><p>结合上面的说明，我们分析下这个语句的执行流程：</p><ol><li>通过客户端/服务器通信协议与 MySQL 建立连接。并查询是否有权限</li><li>Mysql8.0 之前开看是否开启缓存，开启了 Query Cache 且命中完全相同的 SQL 语句，则将查询结果直接返回给客户端；</li><li>由解析器进行语法语义解析，并生成解析树。如查询是 select、表名 tb_student、条件是 id=&lsquo;1&rsquo;</li><li>查询优化器生成执行计划。根据索引看看是否可以优化</li><li>查询执行引擎执行 SQL 语句，根据存储引擎类型，得到查询结果。若开启了 Query Cache，则缓存，否则直接返回。</li></ol><h3 id=回表查询和覆盖索引>回表查询和覆盖索引</h3><p>普通索引（唯一索引+联合索引+全文索引）需要扫描两遍索引树</p><ol><li>先通过普通索引定位到主键值 <code>id=5</code>；</li><li>在通过聚集索引定位到行记录；</li></ol><p>这就是所谓的回表查询，先定位主键值，再定位行记录，它的性能较扫一遍索引树更低。</p><p>覆盖索引：主键索引==聚簇索引==覆盖索引</p><p>如果 where 条件的列和返回的数据在一个索引中，那么不需要回查表，那么就叫覆盖索引。</p><p>实现覆盖索引：常见的方法是，将被查询的字段，建立到联合索引里去。</p><h3 id=explain-及优化>Explain 及优化</h3><p><a href=https://www.jianshu.com/p/8fab76bbf448 target=_blank rel="noopener noreffer">Explain 结果每个字段的含义说明</a></p><h4 id=索引优化>索引优化：</h4><ol><li>最左前缀索引：<code>like</code> 只用于<code>'string%'</code>，语句中的<code>=</code>和 <code>in</code> 会动态调整顺序</li><li>唯一索引：唯一键区分度在 0.1 以上</li><li>无法使用索引：<code>!=</code>、<code>is null</code>、 <code>or</code>、<code>>&lt;</code>、（5.7 以后根据数量自动判定）<code>in</code>、<code>not in</code></li><li>联合索引：避免 <code>select *</code> ，查询列使用覆盖索引</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>#</span><span class=w> </span><span class=err>创建联合覆盖索引，避免回表查询</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>user</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>add</span><span class=w> </span><span class=k>index</span><span class=w> </span><span class=n>idx_gid_ctime_uid</span><span class=w> </span><span class=p>(</span><span class=n>gid</span><span class=p>,</span><span class=w> </span><span class=n>ctime</span><span class=p>,</span><span class=w> </span><span class=n>uid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>uid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>From</span><span class=w> </span><span class=k>user</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Where</span><span class=w> </span><span class=n>gid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>ctime</span><span class=w> </span><span class=k>asc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>limit</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=语句优化>语句优化：</h4><ol><li><p><code>char</code> 固定长度查询效率高，<code>varchar</code> 第一个字节记录数据长度</p></li><li><p>应该针对 <code>Explain</code> 中 <code>Rows</code> 增加索引</p></li><li><p><code>group/order by</code> 字段均会涉及索引</p></li><li><p><code>Limit</code> 中分页查询会随着 <code>start</code> 值增大而变缓慢，通过<strong>子查询+表连接</strong>解决</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=n>mytbl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>limit</span><span class=w> </span><span class=mi>100000</span><span class=p>,</span><span class=mi>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=err>改进后的</span><span class=w> </span><span class=k>SQL</span><span class=w> </span><span class=err>语句如下：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=n>mytbl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=p>(</span><span class=k>select</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>mytbl</span><span class=w> </span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>limit</span><span class=w> </span><span class=mi>100000</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>limit</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=n>mytbl</span><span class=w> </span><span class=k>inner</span><span class=w> </span><span class=n>ori</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=p>(</span><span class=k>select</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>mytbl</span><span class=w> </span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>limit</span><span class=w> </span><span class=mi>100000</span><span class=p>,</span><span class=mi>10</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>tmp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>on</span><span class=w> </span><span class=n>tmp</span><span class=p>.</span><span class=n>id</span><span class=o>=</span><span class=n>ori</span><span class=p>.</span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p><code>count</code> 会进行全表扫描，如果估算可以使用 <code>explain</code></p></li><li><p><code>delete</code> 删除表时会增加大量 <code>undo</code> 和 <code>redo</code> 日志， 确定删除可使用 <code>trancate</code></p></li></ol><h4 id=表结构优化>表结构优化：</h4><ol><li>单库不超过 200 张表</li><li>单表不超过 500w 数据</li><li>单表不超过 40 列</li><li>单表索引不超过 5 个</li></ol><h4 id=数据库范式->数据库范式 ：</h4><ol><li>第一范式（1NF）列不可分割</li><li>第二范式（2NF）属性完全依赖于主键 [ 消除部分子函数依赖 ]</li><li>第三范式（3NF）属性不依赖于其它非主属性 [ 消除传递依赖 ]</li></ol><h4 id=配置优化>配置优化：</h4><p>配置连接数、禁用 Swap、增加内存、升级 SSD 硬盘</p><h3 id=join-查询>JOIN 查询</h3><p><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.3ye73f862e.webp data-srcset="https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.3ye73f862e.webp, https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.3ye73f862e.webp 1.5x, https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.3ye73f862e.webp 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.3ye73f862e.webp title=image.3ye73f862e.webp></p><p><code>left join</code>(左联接) 返回包括左表中的所有记录和右表中关联字段相等的记录</p><p><code>right join</code>(右联接) 返回包括右表中的所有记录和左表中关联字段相等的记录</p><p><code>inner join</code>(等值连接) 只返回两个表中关联字段相等的行</p><h2 id=集群>集群</h2><h3 id=主从复制过程>主从复制过程</h3><h4 id=mysql-主从复制>MySQl 主从复制：</h4><p>原理：将主服务器的 binlog 日志复制到从服务器上执行一遍，达到主从数据的一致状态。</p><p>过程：从库开启一个 I/O 线程，向主库请求 Binlog 日志。主节点开启一个 binlog dump 线程，检查自己的二进制日志，并发送给从节点；从库将接收到的数据保存到中继日志（Relay log）中，另外开启一个 SQL 线程，把 Relay 中的操作在自身机器上执行一遍</p><p>优点：</p><ul><li>作为备用数据库，并且不影响业务</li><li>可做读写分离，一个写库，一个或多个读库，在不同的服务器上，充分发挥服务器和数据库的性能，但要保证数据的一致性</li></ul><h4 id=binlog-记录格式statementrowmixed>binlog 记录格式：statement、row、mixed</h4><p>基于语句 statement 的复制、基于行 row 的复制、基于语句和行（mix）的复制。其中基于 row 的复制方式更能保证主从库数据的一致性，但日志量较大，在设置时考虑磁盘的空间问题。</p><h3 id=数据一致性问题>数据一致性问题</h3><p>&ldquo;主从复制有延时&rdquo;，这个延时期间读取从库，可能读到不一致的数据。</p><h4 id=缓存记录写-key-法>缓存记录写 key 法：</h4><p>在 cache 里记录哪些记录发生过的写请求，来路由读主库还是读从库</p><h4 id=异步复制>异步复制：</h4><p>在异步复制中，主库执行完操作后，写入 binlog 日志后，就返回客户端，这一动作就结束了，并不会验证从库有没有收到，完不完整，所以这样可能会造成数据的不一致。</p><h4 id=半同步复制>半同步复制：</h4><p>当主库每提交一个事务后，不会立即返回，而是等待其中一个从库接收到 Binlog 并成功写入 Relay-log 中才返回客户端，通过一份在主库的 Binlog，另一份在其中一个从库的 Relay-log，可以保证了数据的安全性和一致性。</p><h4 id=全同步复制>全同步复制：</h4><p>指当主库执行完一个事务，所有的从库都执行了该事务才返回给客户端。因为需要等待所有从库执行完该事务才能返回，所以全同步复制的性能必然会收到严重的影响。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2024-07-07&nbsp;<a class=git-hash href=https://github.com/pjimming/blog/commit/02e978f0a52e89cc5f9af7fab75dce874e75226e target=_blank title="commit by panjiangming(panjiangming@kuaishou.com) 02e978f0a52e89cc5f9af7fab75dce874e75226e: update cdn">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>02e978f</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/2024-03-11/mysql/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://blog.pjmcode.top/2024-03-11/mysql/ data-title=面试题精选--MySQL篇 data-hashtags=interview,mysql><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://blog.pjmcode.top/2024-03-11/mysql/ data-hashtag=interview><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://blog.pjmcode.top/2024-03-11/mysql/ data-title=面试题精选--MySQL篇><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://blog.pjmcode.top/2024-03-11/mysql/ data-title=面试题精选--MySQL篇><i data-svg-src=/lib/simple-icons/icons/line.min.svg aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://blog.pjmcode.top/2024-03-11/mysql/ data-title=面试题精选--MySQL篇 data-image=https://cdn.jsdelivr.net/gh/pjimming/picx-images-hosting@master/image.4qr2l18ab2.webp><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/interview/>Interview</a>,&nbsp;<a href=/tags/mysql/>Mysql</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/2024-03-11/golang/ class=prev rel=prev title=面试题精选--Golang篇><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>面试题精选--Golang篇</a>
<a href=/2024-03-12/20240312/ class=next rel=next title=随笔：灵隐寺、法喜寺一日游记>随笔：灵隐寺、法喜寺一日游记<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app>Giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><span id=run-time></span></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://github.com/pjimming/ target=_blank>潘江明</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=备案编号" target=_blank>浙ICP备2024074882号</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.js></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{giscus:{category:"Announcements",categoryId:"DIC_kwDOLZmgDc4Cdm7x",darkTheme:"preferred_color_scheme",emitMetadata:"0",inputPosition:"top",lang:"zh-CN",lazyLoading:!1,lightTheme:"light",mapping:"pathname",reactionsEnabled:"1",repo:"pjimming/blog-comment",repoId:"R_kgDOLZmgDQ"}},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript src=https://cdn.staticfile.net/jquery/2.2.4/jquery.min.js></script><script type=text/javascript src=/js/custom.js></script></body></html>